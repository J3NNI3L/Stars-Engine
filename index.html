<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starz Search Mini-Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- General and Light Mode Styles --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
            transition: background-color 0.3s, color 0.3s;
        }
        #main-content-card {
            background-color: #ffffff;
            border-color: #f3f4f6;
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s, transform 0.3s;
        }
        #iframe-viewer {
            height: 60vh;
            min-height: 400px;
        }
        .text-indigo-700 { color: #4338ca; }
        .bg-indigo-50 { background-color: #eef2ff; }
        
        /* --- Dark Mode Styles --- */
        body.dark-mode {
            background-color: #111827;
            color: #e5e7eb;
        }
        body.dark-mode #main-content-card {
            background-color: #1f2937;
            border-color: #374151;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .text-gray-500 { color: #9ca3af; }
        body.dark-mode .text-gray-800 { color: #f3f4f6; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
            background-color: #374151;
            border-color: #4b5563;
            color: #e5e7eb;
        }
        body.dark-mode input::placeholder, body.dark-mode textarea::placeholder { color: #9ca3af; }
        body.dark-mode .bg-gray-100 { background-color: #374151; }
        body.dark-mode .border-gray-200 { border-color: #4b5563; }
        body.dark-mode .border-gray-300 { border-color: #4b5563; }
        body.dark-mode .text-gray-700 { color: #d1d5db; }
        body.dark-mode .bg-indigo-50 { background-color: #3730a3; }
        body.dark-mode .text-gray-600 { color: #9ca3af; }
        body.dark-mode .hover\:bg-indigo-100:hover { background-color: #4f46e5; }
        body.dark-mode .hover\:bg-green-100:hover { background-color: #10b981; }

        /* --- Custom Theme: Monochrome --- */
        body.monochrome-theme {
            background-color: #000000;
            color: #cccccc;
            filter: grayscale(100%);
        }
        body.monochrome-theme #main-content-card {
            background-color: #1a1a1a;
            border-color: #555555;
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.1);
        }
        body.monochrome-theme .text-indigo-700 { color: #f0f0f0; }
        body.monochrome-theme .bg-indigo-600, body.monochrome-theme .bg-green-600 { 
            background-color: #444444; 
        }
        body.monochrome-theme .hover\:bg-indigo-700:hover, body.monochrome-theme .hover\:bg-green-700:hover { 
            background-color: #666666; 
        }
        body.monochrome-theme .bg-blue-100 { background-color: #333333; }
        body.monochrome-theme .text-blue-800 { color: #cccccc; }
        body.monochrome-theme input, body.monochrome-theme select, body.monochrome-theme textarea {
            background-color: #1a1a1a;
            border-color: #555555;
            color: #cccccc;
        }
        
        /* --- Custom Theme: Golden (DEV MODE ONLY) --- */
        body.golden-theme {
            background-color: #0d121c; /* Dark navy background */
            color: #fff;
        }
        body.golden-theme #main-content-card {
            background-color: #1a1f29; /* Slightly lighter card */
            border-color: #e3c46e; /* Gold border */
            box-shadow: 0 0 30px rgba(227, 196, 110, 0.5); /* Glowing gold shadow */
        }
        body.golden-theme .text-indigo-700 { color: #f5d76e; } /* Gold text */
        body.golden-theme .text-gray-800 { color: #f5d76e; }
        body.golden-theme .bg-indigo-600, body.golden-theme .bg-green-600 { 
            background-color: #e3c46e; /* Gold buttons */
            color: #0d121c;
        }
        body.golden-theme .hover\:bg-indigo-700:hover, body.golden-theme .hover\:bg-green-700:hover { 
            background-color: #f5d76e; 
            color: #0d121c;
        }
        body.golden-theme .bg-blue-100 { background-color: #444444; }
        body.golden-theme .text-blue-800 { color: #f5d76e; }
        body.golden-theme input, body.golden-theme select, body.golden-theme textarea {
            background-color: #2c3340;
            border-color: #e3c46e;
            color: #fff;
        }
        body.golden-theme .bg-indigo-50 { background-color: #3d4a60; border-color: #f5d76e; }
        body.golden-theme .text-gray-700 { color: #fff; }
        body.golden-theme .text-gray-600 { color: #d1d5db; }
        body.golden-theme .border-gray-200 { border-color: #374151; }
        
        /* --- NEW SHOP THEMES --- */
        
        /* PREMIUM Theme */
        body.premium-theme {
            background-color: #000000;
            color: #e0e0e0;
        }
        body.premium-theme #main-content-card {
            background-color: #0a0a0a;
            border-color: #c0c0c0;
            box-shadow: 0 0 40px rgba(192, 192, 192, 0.2);
        }
        body.premium-theme .text-indigo-700 { color: #c0c0c0; }
        body.premium-theme .bg-indigo-600, body.premium-theme .bg-green-600 {
            background-color: #333333;
            color: #e0e0e0;
            border: 1px solid #666666;
        }
        body.premium-theme input, body.premium-theme select, body.premium-theme textarea {
            background-color: #1a1a1a;
            border-color: #666666;
            color: #e0e0e0;
        }

        /* 1. Cyberpunk Theme */
        body.cyberpunk-theme {
            background-color: #150025;
            color: #00ffff;
        }
        body.cyberpunk-theme #main-content-card {
            background-color: #2a004a;
            border-color: #ff0099;
            box-shadow: 0 0 25px rgba(255, 0, 153, 0.5);
        }
        body.cyberpunk-theme .text-indigo-700 { color: #ff0099; }
        body.cyberpunk-theme .bg-indigo-600, body.cyberpunk-theme .bg-green-600 {
            background-color: #ff0099;
            color: #150025;
            text-shadow: 0 0 3px #00ffff;
        }
        body.cyberpunk-theme input, body.cyberpunk-theme select, body.cyberpunk-theme textarea {
            background-color: #330066;
            border-color: #00ffff;
            color: #00ffff;
        }
        body.cyberpunk-theme .bg-indigo-50 { background-color: #330066; border-color: #ff0099; }
        body.cyberpunk-theme .text-gray-700 { color: #00ffff; }
        body.cyberpunk-theme .text-gray-600 { color: #9933ff; }

        /* 2. Ocean Theme */
        body.ocean-theme {
            background-color: #e0f7fa;
            color: #006064;
        }
        body.ocean-theme #main-content-card {
            background-color: #ffffff;
            border-color: #80deea;
            box-shadow: 0 5px 15px rgba(0, 151, 167, 0.2);
        }
        body.ocean-theme .text-indigo-700 { color: #00bcd4; }
        body.ocean-theme .bg-indigo-600, body.ocean-theme .bg-green-600 {
            background-color: #00acc1;
            color: #ffffff;
        }
        body.ocean-theme input, body.ocean-theme select, body.ocean-theme textarea {
            background-color: #f8ffff;
            border-color: #4dd0e1;
            color: #006064;
        }
        body.ocean-theme .bg-indigo-50 { background-color: #b2ebf2; border-color: #0097a7; }

        /* 3. Forest Theme */
        body.forest-theme {
            background-color: #f0f8e9;
            color: #1b5e20;
        }
        body.forest-theme #main-content-card {
            background-color: #ffffff;
            border-color: #81c784;
            box-shadow: 0 5px 15px rgba(27, 94, 32, 0.1);
        }
        body.forest-theme .text-indigo-700 { color: #388e3c; }
        body.forest-theme .bg-indigo-600, body.forest-theme .bg-green-600 {
            background-color: #4caf50;
            color: #ffffff;
        }
        body.forest-theme input, body.forest-theme select, body.forest-theme textarea {
            background-color: #f7fcf7;
            border-color: #a5d6a7;
            color: #1b5e20;
        }
        body.forest-theme .bg-indigo-50 { background-color: #c8e6c9; border-color: #43a047; }

        /* 4. Sunset Theme */
        body.sunset-theme {
            background-color: #ffe0b2;
            color: #d84315;
        }
        body.sunset-theme #main-content-card {
            background: linear-gradient(145deg, #fff3e0, #ffccbc);
            border-color: #ff7043;
            box-shadow: 0 10px 20px rgba(255, 87, 34, 0.3);
        }
        body.sunset-theme .text-indigo-700 { color: #f4511e; }
        body.sunset-theme .bg-indigo-600, body.sunset-theme .bg-green-600 {
            background-color: #ff8a65;
            color: #8d1c02;
        }
        body.sunset-theme input, body.sunset-theme select, body.sunset-theme textarea {
            background-color: #fff8e1;
            border-color: #ffab91;
            color: #d84315;
        }
        body.sunset-theme .bg-indigo-50 { background-color: #ffab91; border-color: #d84315; }

        /* 5. Classic Theme */
        body.classic-theme {
            background-color: #f0f4f8;
            color: #102a43;
        }
        body.classic-theme #main-content-card {
            background-color: #ffffff;
            border-color: #d9e2ec;
            box-shadow: 0 5px 10px rgba(16, 42, 67, 0.1);
        }
        body.classic-theme .text-indigo-700 { color: #52668c; }
        body.classic-theme .bg-indigo-600, body.classic-theme .bg-green-600 {
            background-color: #4a69bd;
            color: #ffffff;
        }
        body.classic-theme input, body.classic-theme select, body.classic-theme textarea {
            background-color: #ffffff;
            border-color: #b8c4d4;
            color: #102a43;
        }
        body.classic-theme .bg-indigo-50 { background-color: #ebf4f8; border-color: #4a69bd; }


        /* --- Fullscreen Simulation Styles (FIX) --- */
        body.fullscreen-active {
            padding: 0 !important;
            margin: 0 !important;
            overflow: hidden;
        }
        .fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw !important;
            max-width: 100vw !important;
            height: 100vh;
            margin: 0 !important;
            padding: 2rem !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            z-index: 100;
            overflow-y: auto;
        }
        .fullscreen-mode #iframe-viewer {
             height: calc(100vh - 150px);
             min-height: auto;
        }

        /* --- Custom Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes scaleUp {
            from { opacity: 0.5; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .animate-scale-up {
            animation: scaleUp 0.5s ease-out;
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        /* New: Emoji Animation Keyframes */
        @keyframes pulse-once {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pulse-once {
            animation: pulse-once 0.5s ease-out;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center p-4 sm:p-8">

    
    <div id="main-content-card" class="w-full max-w-2xl bg-white p-6 sm:p-10 rounded-xl shadow-2xl border border-gray-100 mt-10 animate-scale-up">

        <header class="text-center mb-8 relative">
            
            <div class="absolute top-0 left-0 pt-2 pl-4 text-sm font-semibold text-gray-700 dark:text-gray-300" id="live-clock"></div>
            
            <div class="text-4xl font-extrabold text-indigo-700 dark:text-indigo-400">Starz Search</div>
            <p class="text-gray-500 mt-2">A mini-engine powered by real-time web knowledge.</p>
            
            <div class="absolute top-0 right-0 flex space-x-2">
                
                <button onclick="toggleChat()" class="p-2 text-gray-400 hover:text-indigo-600 transition duration-300 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Community Chat">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 4v-4z" />
                    </svg>
                </button>
                
                <button
                    id="settings-button"
                    onclick="openSettings()"
                    class="p-2 text-gray-400 hover:text-indigo-600 transition duration-300 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"
                    title="Settings"
                >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.536.27.81.543 1.066 2.572z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </div>
        </header>
        
        <div id="iframe-viewer" class="hidden w-full mt-8">
            <button
                id="back-button"
                onclick="resetToSearch()"
                class="mb-4 px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold rounded-lg shadow-sm hover:bg-gray-300 dark:hover:bg-gray-500 transition duration-300 ease-in-out"
            >
                ‚Üê Back to Search
            </button>
            <div class="h-full border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden bg-gray-100 dark:bg-gray-800 relative">
                <iframe 
                    id="external-iframe" 
                    class="w-full h-full" 
                    src="about:blank"
                    sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-modals"
                ></iframe>
                <div id="iframe-fallback" class="absolute inset-0 p-6 text-center text-gray-500 flex flex-col items-center justify-center pointer-events-none transition duration-500 opacity-0">
                    <svg class="w-8 h-8 text-red-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p class="font-bold">Cannot display site.</p>
                    <p class="mt-1 text-sm">This website may block embedding (security policy).</p>
                    <a id="external-link-retry" href="#" target="_blank" rel="noopener noreferrer" class="mt-3 text-indigo-600 hover:underline text-sm font-medium pointer-events-auto transition duration-300">Click here to open in a new tab.</a>
                </div>
            </div>
        </div>

        <div id="search-form-container">
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                
                <datalist id="search-suggestions">
                    <option value="Latest AI News"></option>
                    <option value="Firebase Setup Tutorial"></option>
                    <option value="Starz Shop Themes"></option>
                    <option value="cloudmoonapp.com"></option>
                    <option value="What is Tailwind CSS?"></option>
                </datalist>

                <input
                    id="search-input"
                    type="text"
                    placeholder="Ask anything, e.g., 'What are the latest discoveries in AI?' or 'cloudmoonapp.com'"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-300 ease-in-out dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                    onkeypress="if(event.key === 'Enter') performSearch()"
                    list="search-suggestions"
                >
                <button
                    id="search-button"
                    onclick="performSearch()"
                    class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-300 ease-in-out disabled:opacity-50"
                >
                    Search
                </button>
            </div>

            <div id="timer-section" class="mt-4 flex space-x-2 items-center">
                <input 
                    id="timer-input" 
                    type="number" 
                    placeholder="Set timer (mins)" 
                    min="1"
                    class="w-32 p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                >
                <button
                    onclick="setSimpleTimer()"
                    class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-300 ease-in-out"
                >
                    Set Timer
                </button>
                <span id="timer-status" class="text-sm font-medium text-green-700 dark:text-green-400"></span>
            </div>
            
            <div id="direct-link-container" class="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg shadow-sm hidden dark:bg-yellow-900 dark:border-yellow-700 animate-fade-in">
                <p class="text-sm font-medium text-yellow-800 dark:text-yellow-200 mb-2">Did you mean to go directly to this site? (Recommended: Open in New Tab)</p>
                <button
                    onclick="navigateToUrl(true)" 
                    class="text-sm px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 ease-in-out"
                >
                    Open in New Tab
                </button>
                <button
                    id="direct-link-button"
                    onclick="navigateToUrl(false)" 
                    class="text-sm px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition duration-300 ease-in-out ml-2"
                >
                    Try viewing <span id="direct-link-text" class="font-bold"></span> internally (May be blocked)
                </button>
            </div>
        </div>
        
        <div id="dev-panel" class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 hidden animate-fade-in">
            <h3 class="text-xl font-bold text-red-600 dark:text-red-400 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                Developer Panel: GOLD STATUS
            </h3>
            <div class="space-y-3">
                <p class="text-sm text-gray-700 dark:text-gray-300">Welcome, Developer! Your custom ID has been activated. You now have access to the **Golden Theme** in settings.</p>
                <button class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 ease-in-out">
                    Access Debug Logs (Simulated)
                </button>
                <button onclick="localStorage.clear(); location.reload();" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition duration-300 ease-in-out">
                    Clear Local Storage (Hard Reset)
                </button>
            </div>
        </div>
        
        <div class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Top Searches Today
                <span id="loading-searches" class="hidden ml-3 text-sm text-gray-500">Loading...</span>
            </h3>
            <div id="top-searches" class="flex flex-wrap gap-2 min-h-[40px] items-center">
                <p id="no-searches-message" class="text-gray-400 text-sm hidden">Start searching to see popular topics!</p>
                </div>
        </div>
        
        <div class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Games & Utilities
            </h3>
            <div id="games-section" class="grid grid-cols-2 gap-4 sm:grid-cols-4">
                <a href="javascript:void(0)" onclick="openGameInternally('cloudmoonapp.com')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-300 ease-in-out border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-green-900">
                    Cloud Moon App
                </a>
                <a href="javascript:void(0)" onclick="openGameInternally('play.geforcenow.com')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-300 ease-in-out border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-green-900">
                    GeForce NOW
                </a>
                <a href="javascript:void(0)" onclick="openGameInternally('poki.com')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-300 ease-in-out border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-green-900">
                    Poki (Web Games)
                </a>
                <a href="javascript:void(0)" onclick="openGameInternally('krunker.io')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-300 ease-in-out border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-green-900">
                    Krunker.io
                </a>
                <a href="javascript:void(0)" onclick="openGameInternally('agar.io')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-300 ease-in-out border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-green-900">
                    Agar.io
                </a>
                <a href="javascript:void(0)" onclick="openGameInternally('coolmathgames.com')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-300 ease-in-out border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-green-900">
                    Cool Math Games
                </a>
                <a href="javascript:void(0)" onclick="openNotepad()" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-indigo-100 transition duration-300 ease-in-out border border-gray-200 text-sm font-medium text-gray-700 hover:text-indigo-800 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-indigo-900">
                    In-Page Notepad üìù
                </a>
            </div>
        </div>

        <div id="loading" class="hidden text-center mt-6 text-indigo-600 font-medium">
            <div class="flex items-center justify-center space-x-2">
                <svg class="animate-spin h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Searching the web...</span>
            </div>
        </div>

        <div id="results" class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 hidden animate-fade-in">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Search Result</h2>

            <div id="summary-text" class="p-5 bg-indigo-50 border-l-4 border-indigo-600 rounded-r-lg text-lg text-gray-700 leading-relaxed shadow-sm dark:bg-indigo-900 dark:text-gray-100">
                </div>

            <div id="feedback-section" class="mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg flex justify-between items-center animate-fade-in">
                <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">Was this result helpful? Rate it!</p>
                <div class="flex space-x-2">
                    <button onclick="submitFeedback('like')" title="Upvote (+10 Points)" class="p-2 bg-green-500 text-white rounded-full hover:bg-green-600 transition duration-300 transform hover:scale-110">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-7.012a2 2 0 01-1.789-2.894l3.5-7A2 2 0 0110.764 10h4.764zm-1.5 0H10a2 2 0 01-1.789-2.894l3.5-7A2 2 0 0113.264 3h7.012a2 2 0 011.789 2.894l-3.5 7A2 2 0 0117.264 10h-1.5z"></path></svg>
                    </button>
                    <button onclick="submitFeedback('dislike')" title="Downvote (-2 Points)" class="p-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition duration-300 transform hover:scale-110">
                        <svg class="w-5 h-5 transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-7.012a2 2 0 01-1.789-2.894l3.5-7A2 2 0 0110.764 10h4.764zm-1.5 0H10a2 2 0 01-1.789-2.894l3.5-7A2 2 0 0113.264 3h7.012a2 2 0 011.789 2.894l-3.5 7A2 2 0 0117.264 10h-1.5z"></path></svg>
                    </button>
                </div>
            </div>
            <div id="feedback-message" class="mt-2 text-sm font-medium text-center text-green-600 dark:text-green-400 hidden animate-fade-in"></div>
            <div class="mt-6">
                <h3 class="text-sm font-semibold uppercase text-gray-500 dark:text-gray-400 mb-2">Sources</h3>
                <ul id="sources-list" class="space-y-2 text-sm">
                    </ul>
            </div>
        </div>

        <div id="error-message" class="hidden mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg dark:bg-red-900 dark:border-red-700 dark:text-red-200 animate-fade-in">
            An error occurred. Please try again.
        </div>

    </div>

    <div id="notepad-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 hidden" onclick="closeNotepad()"></div>
    <div id="notepad-modal" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-xl bg-white p-6 sm:p-8 rounded-xl shadow-2xl z-50 hidden dark:bg-gray-800 animate-scale-up">
        
        <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-6 border-b pb-4 flex justify-between items-center">
            My Notes üìù
            <button onclick="closeNotepad()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </h2>

        <textarea id="notepad-text-area" rows="15" placeholder="Write down your search ideas, secret gold IDs, or reminders here. Your notes are saved automatically!"
            class="w-full p-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-inner dark:bg-gray-700 dark:border-gray-600 dark:text-white resize-none"
            oninput="saveNotepadContent()"
        ></textarea>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-right">Saved automatically to your browser.</p>
    </div>
    <div id="settings-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 hidden" onclick="closeSettings()"></div>
    <div id="settings-modal" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-xl bg-white p-6 sm:p-8 rounded-xl shadow-2xl z-50 hidden dark:bg-gray-800 animate-scale-up">
        
        <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-6 border-b pb-4 flex justify-between items-center">
            Settings
            <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </h2>

        <div class="space-y-6 max-h-[80vh] overflow-y-auto pr-2">
            
            <div class="p-4 bg-yellow-50 dark:bg-yellow-900 border-l-4 border-yellow-500 rounded-r-lg shadow-sm flex justify-between items-center animate-fade-in">
                <h3 class="text-xl font-bold text-yellow-800 dark:text-yellow-200">
                    <span id="premium-badge" class="hidden mr-2 text-xs font-extrabold bg-indigo-600 text-white px-2 py-1 rounded-full uppercase">PREMIUM</span>
                    Your Points:
                </h3>
                <p id="points-display" class="text-3xl font-extrabold text-indigo-700 dark:text-yellow-400">100</p>
            </div>

            <div class="p-4 bg-blue-50 dark:bg-blue-900 border-l-4 border-blue-500 rounded-r-lg shadow-sm animate-fade-in">
                <h3 class="text-lg font-bold text-blue-800 dark:text-blue-200 mb-2">Your Profile</h3>
                <p class="text-sm text-gray-700 dark:text-gray-300">User ID: <span id="user-id-display" class="font-mono font-semibold">...</span></p>
                <p id="dev-status-message" class="text-sm font-medium mt-1">Status: <span class="text-gray-500 font-normal">Disabled</span></p>
            </div>
            
            <div class="pb-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2">Developer Mode Access</h3>
                <div class="flex space-x-2">
                    <input type="text" id="custom-dev-id-input" placeholder="Enter GOLD ID" maxlength="20"
                        class="flex-grow p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                    >
                    <button onclick="applyCustomId()" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 ease-in-out"
                    >
                        Activate
                    </button>
                </div>
            </div>

            <div class="pb-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2">Music Player (Spotify)</h3>
                <p id="music-player-status" class="text-sm text-gray-500 dark:text-gray-400 mb-3">Status: Not playing</p>
                <div class="flex space-x-2">
                    <input type="text" id="spotify-search-input" placeholder="Paste Spotify Track/Playlist URL or ID"
                        class="flex-grow p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                    >
                    <button onclick="startSpotifyPlayer()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 ease-in-out"
                    >
                        ‚ñ∂ Load Player
                    </button>
                </div>
                <div id="spotify-player-embed" class="mt-4 rounded-lg overflow-hidden min-h-[80px] border border-gray-300 dark:border-gray-700">
                </div>
            </div>
            
            <div class="pb-4 border-b border-gray-200 dark:border-gray-700">
                <label for="theme-selector" class="block text-lg font-bold text-gray-800 dark:text-white mb-2">Custom Theme</label>
                <select id="theme-selector" onchange="setTheme(this.value)"
                    class="w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="light">Light Mode (Default)</option>
                    <option value="dark">Dark Mode (Default)</option>
                    <option value="monochrome">Monochrome Theme (Default)</option>
                </select>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Locked themes will be greyed out if you do not own them.
                </p>
            </div>
            
            <div class="pb-4 border-b border-gray-200 dark:border-gray-700">
                <label for="volume-slider" class="block text-lg font-bold text-gray-800 dark:text-white mb-2">Volume Control (Simulated)</label>
                <input type="range" id="volume-slider" min="0" max="100" value="70" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400 mt-1">
                    <span>0%</span>
                    <span id="volume-value">70%</span>
                    <span>100%</span>
                </div>
            </div>
            
            <div class="pb-4 border-b border-gray-200 dark:border-gray-700">
                <label for="site-view-selector" class="block text-lg font-bold text-gray-800 dark:text-white mb-2">Default Site View</label>
                <select id="site-view-selector" onchange="saveSiteViewPreference(this.value)"
                    class="w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="prompt">Ask Before Opening</option>
                    <option value="internal">Try Internal Embed</option>
                    <option value="newtab">Always Open in New Tab</option>
                </select>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    How the engine should handle direct website links.
                </p>
            </div>

            <div id="shop-section" class="pt-4 border-t border-gray-200 dark:border-gray-700">
                <h3 class="text-2xl font-bold text-indigo-700 dark:text-indigo-400 mb-4">Starz Shop ‚ú®</h3>
                <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">Spend your points on exclusive themes and features!</p>
                <div id="shop-items-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    </div>
            </div>
        </div>
    </div>

    <div id="chat-panel" class="fixed top-0 right-0 h-full w-80 bg-white dark:bg-gray-800 shadow-xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col border-l border-gray-200 dark:border-gray-700">
        <div class="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold text-indigo-700 dark:text-indigo-400">Starz Community Chat üí¨</h2>
            <button onclick="toggleChat()" class="text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-400 transition">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div id="messages" class="flex-grow p-4 overflow-y-auto space-y-3">
            <p class="text-center text-sm text-gray-400">Loading messages...</p>
        </div>

        <div class="p-4 border-t border-gray-200 dark:border-gray-700">
            <input type="text" id="username-input" placeholder="Your Username (Saved)" maxlength="20"
                class="w-full mb-2 p-2 text-sm bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" />
            
            <form id="message-form" class="flex space-x-2">
                <input type="text" id="message-input" placeholder="Type a message..." required
                    class="flex-grow p-3 text-sm bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" />
                <button type="submit" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition font-semibold">Send</button>
            </form>
        </div>
    </div>
    <div id="loading-engine-overlay" class="fixed inset-0 bg-white dark:bg-gray-900 bg-opacity-95 dark:bg-opacity-95 backdrop-blur-sm z-[110] hidden flex flex-col items-center justify-center p-8 animate-fade-in">
        <div class="max-w-md w-full text-center">
            <div id="loading-emoji" class="text-6xl mb-6">üîç</div>
            <h2 class="text-3xl font-extrabold text-indigo-700 dark:text-indigo-400 mb-4">
                Starz Search Engine is Loading...
            </h2>
            <p class="text-lg text-gray-700 dark:text-gray-300 mb-6">
                Estimated time: <span id="load-countdown" class="font-bold text-red-500">15s</span>
            </p>
            <div class="w-3/4 mx-auto bg-gray-700 rounded-full h-2.5 mb-8">
                <div id="load-progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <div class="p-4 bg-gray-800 rounded-lg border border-gray-700 shadow-lg animate-fade-in">
                <p class="text-xs font-semibold uppercase text-indigo-400 mb-2">Pro Tip:</p>
                <p id="loading-tip" class="text-sm text-gray-300 italic">Loading Tip...</p>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-4">
                <span id="concurrent-users" class="font-bold">...</span> concurrent users online.
            </p>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Ensure you have the full list of imports needed for your Firebase version (v9+)
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose serverTimestamp and other variables globally
        window.serverTimestamp = serverTimestamp;
        
        // Global Firebase variables
        let app;
        let db;
        
        // Configuration and ID from the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'SIMULATED-USER-1337-DEFAULT';
        
        // --- YOUR FIREBASE CONFIGURATION (MODIFIED) ---
        // **IMPORTANT:** You must fill in the placeholder values below with your actual project details.
        const firebaseConfig = {
            apiKey: "AIzaSyBpGIIeQhMdgsK640pjuvuUr8GyuGgUC3s", // <-- YOUR KEY INSERTED HERE
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID", // <-- MUST BE FILLED
            storageBucket: "YOUR_PROJECT_ID.appspot.com", // <-- MUST BE FILLED
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // <-- MUST BE FILLED
            appId: "YOUR_APP_ID" // <-- MUST BE FILLED
        };
        // --- END FIREBASE CONFIGURATION ---

        window.appId = appId; // Expose to global scope
        
        // Initialize Firebase for Top Searches and Chat logging
        if (firebaseConfig.apiKey.length > 0 && firebaseConfig.projectId.includes('YOUR_PROJECT_ID') === false) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                // setLogLevel('debug'); // Uncomment for debugging
                window.db = db; // Expose to global scope for logSearch and chat
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                alert("Firebase failed to initialize. Check your API key and project settings.");
            }
        } else {
             console.warn("Firebase not initialized: Project ID placeholders are not replaced.");
        }


        /** * Logs a successful, non-URL search query to Firestore. 
         */
        window.logSearch = async function(query) {
            if (!db || query.length < 5) return;
            try {
                const searchesCollectionPath = `/artifacts/${appId}/public/data/top_searches`;
                // In v9+, use addDoc and collection: 
                // await addDoc(collection(db, searchesCollectionPath), { ... }); 
                // Using a simulated v8 fallback for simplicity/compatibility in a single file scenario:
                if (db.collection) { // Check for v8 style collection method
                    await db.collection(searchesCollectionPath).add({
                        query: query,
                        timestamp: serverTimestamp()
                    });
                } else if (typeof addDoc === 'function') { // Use v9 method if available
                    await addDoc(collection(db, searchesCollectionPath), {
                        query: query,
                        timestamp: serverTimestamp()
                    });
                }
            } catch (error) {
                console.error("Error logging search to Firestore:", error);
            }
        }

        /** * Fetches and displays the most popular searches from Firestore. 
         */
        window.loadTopSearches = async function() {
            if (!db) {
                document.getElementById('no-searches-message').classList.remove('hidden');
                return;
            }

            const topSearchesDiv = document.getElementById('top-searches');
            const noSearchesMessage = document.getElementById('no-searches-message');
            const loadingSpan = document.getElementById('loading-searches');

            loadingSpan.classList.remove('hidden');
            topSearchesDiv.innerHTML = '';

            try {
                const searchesCollectionPath = `/artifacts/${appId}/public/data/top_searches`;
                let querySnapshot;
                
                if (db.collection) { // Check for v8 style collection method
                    const q = db.collection(searchesCollectionPath).orderBy('timestamp', 'desc').limit(100);
                    querySnapshot = await q.get();
                } else if (typeof query === 'function') { // Use v9 method if available
                    const q = query(collection(db, searchesCollectionPath), orderBy('timestamp', 'desc'), limit(100));
                    querySnapshot = await getDocs(q);
                } else {
                    throw new Error("Firestore methods not accessible.");
                }


                const queryCounts = {};
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const queryText = data.query.toLowerCase();
                    queryCounts[queryText] = (queryCounts[queryText] || 0) + 1;
                });

                const sortedQueries = Object.entries(queryCounts)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 5);

                if (sortedQueries.length === 0) {
                    noSearchesMessage.classList.remove('hidden');
                } else {
                    noSearchesMessage.classList.add('hidden');
                    sortedQueries.forEach(([queryText]) => {
                        const button = document.createElement('button');
                        button.textContent = '#' + queryText.charAt(0).toUpperCase() + queryText.slice(1);
                        button.onclick = () => window.performQuickSearch(queryText);
                        button.className = "px-4 py-2 text-sm font-semibold rounded-full bg-blue-100 text-blue-800 hover:bg-blue-200 transition duration-300 shadow-sm dark:bg-blue-900 dark:text-blue-100 dark:hover:bg-blue-800";
                        topSearchesDiv.appendChild(button);
                    });
                }

            } catch (error) {
                console.error("Error loading top searches:", error);
                topSearchesDiv.innerHTML = `<p class="text-sm text-red-500">Error loading popular searches. (Check rules/project ID)</p>`;
            } finally {
                loadingSpan.classList.add('hidden');
            }
        }
    </script>


    <script>
        // --- SHOP & STATE CONSTANTS AND GLOBAL STATE ---
        const PREMIUM_THEME_KEY = 'premium'; // Key for the premium theme
        const PREMIUM_LOAD_TIME = 5; // seconds (Premium Benefit)
        const STANDARD_LOAD_TIME = 15; // seconds
        const DEV_IDS = ['STARZ-GOLD-1337', 'STARZ-DEV-9000']; // List of valid Developer IDs
        const TIPS = [
            "Premium Members enjoy 5-second loading times!",
            "Did you know you can set a timer right on the search bar?",
            "Use the Settings modal to change your theme.",
            "Try searching for 'Cool Math Games' to access the games section easily.",
            "You can unlock new themes in the Starz Shop!",
            "The volume control in settings is for ambiance only. (Simulated)"
        ];
        const EMOJIS = ['üöÄ', '‚ú®', 'üí°', 'üîç', '‚≠ê', 'üß†'];

        const SHOP_ITEMS = {
            'premium_membership': { name: 'Premium Membership', cost: 500, type: 'membership', themeKey: PREMIUM_THEME_KEY, description: 'Faster loading (5s), exclusive theme, and a lifetime code. (1-time purchase)' },
            'cyberpunk': { name: 'Cyberpunk Theme', cost: 150, type: 'theme', themeKey: 'cyberpunk', description: 'Neon aesthetic with bright accents.' },
            'ocean': { name: 'Ocean Theme', cost: 150, type: 'theme', themeKey: 'ocean', description: 'Calm blues and whites.' },
            'forest': { name: 'Forest Theme', cost: 150, type: 'theme', themeKey: 'forest', description: 'Earthy greens and browns.' },
            'sunset': { name: 'Sunset Theme', cost: 150, type: 'theme', themeKey: 'sunset', description: 'Warm orange and pink tones.' },
            'classic': { name: 'Classic Theme', cost: 150, type: 'theme', themeKey: 'classic', description: 'Professional blue and grey palette.' }
        };
        
        // State variables
        window.userPoints = parseInt(localStorage.getItem('userPoints') || '100', 10);
        let ownedThemes = JSON.parse(localStorage.getItem('ownedThemes') || '[]');
        let isPremium = localStorage.getItem('isPremium') === 'true';
        let isDevMode = localStorage.getItem('isDevMode') === 'true';
        let siteViewPreference = localStorage.getItem('siteViewPreference') || 'prompt'; // 'prompt', 'internal', or 'newtab'
        
        let timerTimeout;
        let countdownInterval;
        let loadTimeout;
        let emojiInterval;

        // --- MOCK API RESPONSE (Used when no real API is connected) ---
        const MOCK_SUMMARY = "The Starz Search Mini-Engine is designed with a focus on delivering a fast, personalized user experience, incorporating features like a modern search interface, game shortcuts, and a point-based shop for theme customization. Its core functionality simulates real-time web search capability, providing concise, referenced answers. The interface is built using Tailwind CSS for a modern aesthetic and simple responsiveness. Features like custom themes and advanced settings, which were recently added, enhance user control and personalization, contributing significantly to a positive UX. Clean architecture ensures the application is robust and maintainable.";
        const MOCK_SOURCES = [
            { uri: 'https://mock-source-1.com/ux-principles', title: 'UX Design Principles for Modern Web' },
            { uri: 'https://mock-source-2.dev/clean-code-architecture', title: 'Fundamentals of Clean Code and Scalability' },
            { uri: 'https://mock-source-3.org/future-web-standards', title: 'The Future of Web Customization and Theming' }
        ];

        // --- UI Element References ---
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const loadingDiv = document.getElementById('loading');
        const resultsDiv = document.getElementById('results');
        const summaryTextDiv = document.getElementById('summary-text');
        const sourcesList = document.getElementById('sources-list');
        const errorDiv = document.getElementById('error-message');
        const searchFormContainer = document.getElementById('search-form-container');
        const mainContentCard = document.getElementById('main-content-card');
        const devPanelDiv = document.getElementById('dev-panel');

        // UI References for direct link/iframe
        const directLinkDiv = document.getElementById('direct-link-container');
        const directLinkTextSpan = document.getElementById('direct-link-text');
        const iframeViewerDiv = document.getElementById('iframe-viewer');
        const externalIframe = document.getElementById('external-iframe');
        const externalLinkRetry = document.getElementById('external-link-retry');

        // UI References for Settings Modal
        const settingsModal = document.getElementById('settings-modal');
        const settingsOverlay = document.getElementById('settings-modal-overlay');
        const userIdDisplay = document.getElementById('user-id-display');
        const themeSelector = document.getElementById('theme-selector');
        const siteViewSelector = document.getElementById('site-view-selector');
        const devStatusMessage = document.getElementById('dev-status-message');

        // NEW SHOP REFERENCES
        const pointsDisplay = document.getElementById('points-display');
        const shopItemsContainer = document.getElementById('shop-items-container');
        const premiumBadge = document.getElementById('premium-badge');

        // NEW UI References for Loading Engine
        const loadingEngineOverlay = document.getElementById('loading-engine-overlay');
        const loadCountdownSpan = document.getElementById('load-countdown');
        const loadingEmojiDiv = document.getElementById('loading-emoji');
        const loadingTipP = document.getElementById('loading-tip');
        const concurrentUsersSpan = document.getElementById('concurrent-users');
        const loadProgressBar = document.getElementById('load-progress-bar');

        // UI References for Chat
        const chatPanel = document.getElementById('chat-panel');
        const messagesDiv = document.getElementById('messages');
        const usernameInput = document.getElementById('username-input');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        let chatUsername = localStorage.getItem('chatUsername') || 'StarzGuest-' + Math.floor(Math.random() * 10000);
        
        // NEW UI References for Notepad
        const notepadModal = document.getElementById('notepad-modal');
        const notepadOverlay = document.getElementById('notepad-modal-overlay');
        const notepadTextArea = document.getElementById('notepad-text-area');

        // NEW UI References for Feedback
        const feedbackSection = document.getElementById('feedback-section');
        const feedbackMessage = document.getElementById('feedback-message');


        // --- CHAT LOGIC ---

        /**
         * Toggles the chat sidebar visibility.
         */
        function toggleChat() {
            chatPanel.classList.toggle('translate-x-full');
            
            // Clear the message input when closing
            if (chatPanel.classList.contains('translate-x-full')) {
                messageInput.value = '';
            }
        }

        /**
         * Initializes the chat room logic, called on window.onload.
         */
        function initChat() {
            if (typeof window.db === 'undefined') {
                console.warn("Firestore 'db' not found. Chat will only be visible but won't function.");
                messagesDiv.innerHTML = '<p class="text-center text-sm text-red-500">Chat services unavailable (Firestore not initialized).</p>';
                return;
            }
            
            usernameInput.value = chatUsername;
            
            // Attach event listeners
            usernameInput.addEventListener('input', updateUsername);
            messageForm.addEventListener('submit', sendMessage);
            
            // Start listening for real-time messages
            listenForMessages();
        }

        /**
         * Saves the username to localStorage whenever the user changes it.
         */
        function updateUsername(e) {
            chatUsername = e.target.value.trim().substring(0, 20); // enforce max length
            localStorage.setItem('chatUsername', chatUsername);
        }

        /**
         * Handles sending a new message to Firestore.
         */
        async function sendMessage(e) {
            e.preventDefault();
            const message = messageInput.value.trim();
            
            if (!chatUsername || !message || typeof window.db === 'undefined' || typeof window.serverTimestamp === 'undefined') return;

            try {
                // Use a simulated v8 fallback for simplicity/compatibility in a single file scenario:
                if (window.db.collection) { 
                    await window.db.collection('chats').add({
                        username: chatUsername,
                        message: message,
                        timestamp: window.serverTimestamp()
                    });
                } else {
                    // Assuming v9 structure is handled by the module import if available
                    alert("Firestore API v9 addDoc function is required for sending messages.");
                    return;
                }
                
                messageInput.value = ''; // Clear input after successful send
            } catch (error) {
                console.error("Error sending message: ", error);
                alert("Failed to send message. This may be due to Firebase Security Rules.");
            }
        }

        /**
         * Subscribes to real-time updates from Firestore and displays messages.
         */
        function listenForMessages() {
            if (typeof window.db === 'undefined' || typeof window.firebase === 'undefined') return;

            // Use the simulated v8 fallback for onSnapshot
            if (window.db.collection) {
                window.db.collection('chats')
                    .orderBy('timestamp', 'desc') // Get newest messages first
                    .limit(50) // Limit to the last 50 messages
                    .onSnapshot(snapshot => {
                        messagesDiv.innerHTML = ''; // Clear existing messages
                        
                        // Reverse the order to display newest at the bottom
                        const reversedDocs = snapshot.docs.reverse(); 

                        if (reversedDocs.length === 0) {
                            messagesDiv.innerHTML = '<p class="text-center text-sm text-gray-400">No messages yet. Be the first!</p>';
                            return;
                        }

                        reversedDocs.forEach(doc => {
                            const data = doc.data();
                            // Format time or show '...' if timestamp hasn't arrived from server yet
                            const time = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '...';

                            const isMe = data.username === chatUsername;
                            
                            // Tailwind classes for styling chat bubbles
                            const bubbleClasses = isMe ? 'self-end bg-indigo-600 text-white rounded-bl-xl' : 'self-start bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white rounded-br-xl';
                            const nameClasses = isMe ? 'text-white' : 'text-indigo-600 dark:text-indigo-400';
                            
                            const messageHtml = `
                                <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                                    <span class="text-xs ${nameClasses} font-semibold mb-0.5">${data.username}</span>
                                    <div class="max-w-xs p-3 text-sm rounded-t-xl ${bubbleClasses} shadow-md break-words whitespace-pre-wrap">
                                        ${data.message}
                                    </div>
                                    <span class="text-xs text-gray-400 dark:text-gray-500 mt-1">${time}</span>
                                </div>
                            `;
                            messagesDiv.innerHTML += messageHtml;
                        });
                        
                        // Auto-scroll to the bottom (newest message)
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }, error => {
                        console.error("Error listening to chat messages: ", error);
                        messagesDiv.innerHTML = '<p class="text-center text-sm text-red-500">Could not connect to chat. Check your Firebase Project ID and Security Rules.</p>';
                    });
            }
        }
        
        // Expose initChat and toggleChat to the global scope
        window.initChat = initChat;
        window.toggleChat = toggleChat;
        
        // --- NEW NOTEPAD LOGIC ---
        function openNotepad() {
            notepadTextArea.value = localStorage.getItem('notepadContent') || '';
            notepadModal.classList.remove('hidden');
            notepadOverlay.classList.remove('hidden');
            notepadTextArea.focus();
        }
        window.openNotepad = openNotepad;

        function closeNotepad() {
            notepadModal.classList.add('hidden');
            notepadOverlay.classList.add('hidden');
        }
        window.closeNotepad = closeNotepad;

        function saveNotepadContent() {
            localStorage.setItem('notepadContent', notepadTextArea.value);
        }
        window.saveNotepadContent = saveNotepadContent;


        // --- NEW FEEDBACK LOGIC ---
        function submitFeedback(type) {
            // Disable buttons immediately to prevent spamming
            feedbackSection.querySelectorAll('button').forEach(btn => btn.disabled = true);
            
            if (isDevMode) {
                feedbackMessage.textContent = `Thanks, Dev! Feedback (${type}) logged to your simulated dashboard.`;
            } else {
                if (type === 'like') {
                    userPoints += 10;
                    localStorage.setItem('userPoints', userPoints.toString());
                    feedbackMessage.textContent = `Thanks for the "Like"! You earned 10 points. Current points: ${getPointsDisplay()}`;
                } else {
                    userPoints = Math.max(0, userPoints - 2); 
                    localStorage.setItem('userPoints', userPoints.toString());
                    feedbackMessage.textContent = `Feedback received. We'll use this to improve! (-2 points). Current points: ${getPointsDisplay()}`;
                }
            }

            feedbackMessage.classList.remove('hidden');
            
            // Clear message after a short delay
            setTimeout(() => feedbackMessage.classList.add('hidden'), 5000);
            
            // Re-render shop to update points display in the settings modal
            if (settingsModal.classList.contains('hidden') === false) {
                renderShop(); 
            }
        }
        window.submitFeedback = submitFeedback; // Expose globally

        // --- UTILITY FUNCTIONS ---

        /**
         * Gets a user-friendly string for the current points.
         */
        function getPointsDisplay() {
            return isDevMode ? "‚àû" : userPoints.toLocaleString();
        }

        /**
         * Renders the shop content based on ownership and points.
         */
        function renderShop() {
            shopItemsContainer.innerHTML = '';
            pointsDisplay.textContent = getPointsDisplay();
            
            // Build the final theme list for the settings dropdown
            const finalThemes = [];
            const themeMap = {};

            // Add default themes first
            finalThemes.push(
                { value: 'light', name: 'Light Mode (Default)', isLocked: false },
                { value: 'dark', name: 'Dark Mode (Default)', isLocked: false },
                { value: 'monochrome', name: 'Monochrome Theme (Default)', isLocked: false }
            );

            // Map keys to the order they appear in SHOP_ITEMS for rendering
            const shopItemKeys = Object.keys(SHOP_ITEMS);
            shopItemKeys.forEach(key => {
                const item = SHOP_ITEMS[key];
                const isOwned = key === 'premium_membership' ? isPremium : ownedThemes.includes(item.themeKey);
                
                // Add theme to the selector list
                if (item.type === 'theme' || item.themeKey === PREMIUM_THEME_KEY) {
                     themeMap[item.themeKey] = item;
                }

                // Render the shop item card
                const isMembership = item.type === 'membership';
                const buttonText = isOwned ? (isMembership ? '‚úì Owned' : '‚úì Use') : `Buy (${item.cost})`;
                const buttonColor = isOwned ? 'bg-gray-400 hover:bg-gray-500' : (isDevMode || userPoints >= item.cost ? 'bg-green-600 hover:bg-green-700' : 'bg-red-400');
                const isDisabled = isOwned || (!isDevMode && userPoints < item.cost);
                let premiumInfo = '';

                if (key === 'premium_membership' && isOwned) {
                    // Simulated premium code
                    const premiumCode = 'STARZ-PREM-1337-CODE';
                    premiumInfo = `<p class="mt-2 text-xs text-yellow-500 dark:text-yellow-300 font-mono break-all">Lifetime Code: ${premiumCode}</p>`;
                }
                
                const itemHtml = `
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow-md border ${isOwned ? 'border-indigo-400' : 'border-gray-200 dark:border-gray-600'}">
                        <h4 class="text-lg font-bold ${isOwned ? 'text-indigo-600 dark:text-indigo-400' : 'text-gray-800 dark:text-white'}">${item.name}</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${item.description}</p>
                        ${premiumInfo}
                        <button 
                            onclick="buyItem('${key}')"
                            class="mt-3 w-full px-4 py-2 ${buttonColor} text-white font-semibold rounded-lg transition duration-300 disabled:opacity-50"
                            ${isDisabled ? 'disabled' : ''}
                        >
                            ${buttonText}
                        </button>
                    </div>
                `;
                shopItemsContainer.innerHTML += itemHtml;
            });

            // Add shop themes and premium theme in the selector
            Object.values(themeMap).forEach(item => {
                const isOwned = ownedThemes.includes(item.themeKey) || (item.themeKey === PREMIUM_THEME_KEY && isPremium);
                const themeName = item.name.replace(' Theme', '');
                finalThemes.push({
                    value: item.themeKey,
                    name: `${themeName} Theme ${isOwned ? ' (Owned)' : ' (Locked)'}`,
                    isLocked: !isOwned && !isDevMode,
                    isPremium: item.themeKey === PREMIUM_THEME_KEY
                });
            });
            
            // Add Golden Theme if in Dev Mode
            if (isDevMode) {
                finalThemes.push({ value: 'golden', name: 'Golden Theme (DEV ONLY)' });
            }

            themeSelector.innerHTML = '';
            finalThemes.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme.value;
                option.textContent = theme.name;
                option.disabled = theme.isLocked;
                themeSelector.appendChild(option);
            });

            // Set the currently active theme
            const currentTheme = localStorage.getItem('theme') || 'dark';
            themeSelector.value = currentTheme;

            // Show premium badge if applicable
            premiumBadge.classList.toggle('hidden', !isPremium);
        }
        window.renderShop = renderShop; // Expose globally

        /**
         * Handles the purchase logic for a shop item.
         */
        function buyItem(itemKey) {
            const item = SHOP_ITEMS[itemKey];
            if (!item) return;

            // Check if already owned/premium
            if (itemKey === 'premium_membership' && isPremium) return;
            if (item.type === 'theme' && ownedThemes.includes(item.themeKey)) return;

            // Check points (Devs have infinite points)
            if (!isDevMode && userPoints < item.cost) {
                alert("Not enough points! You need " + (item.cost - userPoints) + " more points.");
                return;
            }

            // Deduct points
            if (!isDevMode) {
                userPoints -= item.cost;
                localStorage.setItem('userPoints', userPoints.toString());
            }

            // Apply purchase effect
            if (item.type === 'membership') {
                isPremium = true;
                localStorage.setItem('isPremium', 'true');
                setTheme(item.themeKey, true); // Automatically apply premium theme
            } else if (item.type === 'theme') {
                if (!ownedThemes.includes(item.themeKey)) {
                    ownedThemes.push(item.themeKey);
                    localStorage.setItem('ownedThemes', JSON.stringify(ownedThemes));
                }
                setTheme(item.themeKey, true); // Automatically switch to new theme
            }

            // Re-render to update points and button status
            renderShop();
            
            // Give feedback
            alert(`Purchase successful! You bought ${item.name}.`);
        }
        window.buyItem = buyItem; // Expose globally

        /**
         * Updates the music player iframe based on a Spotify link or ID.
         */
        function startSpotifyPlayer() {
            const searchInput = document.getElementById('spotify-search-input');
            const statusDisplay = document.getElementById('music-player-status');
            const embedContainer = document.getElementById('spotify-player-embed');
            const query = searchInput.value.trim();
            embedContainer.innerHTML = '';

            if (!query) {
                statusDisplay.innerHTML = `Status: <span class="text-yellow-500 font-bold">Please paste a Spotify track or playlist URL.</span>`;
                return;
            }

            // Regex to find Spotify track/album/playlist ID/type from various URLs or raw IDs
            const spotifyRegex = /(?:spotify\.com\/(track|album|playlist|episode|show)\/|spotify:)([\w\d]+)/i;
            const match = query.match(spotifyRegex);
            let embedUrl;

            if (match) {
                // If it's a URL, use the captured type and ID
                const type = match[1];
                const id = match[2];
                // Use &theme=0 for dark player, &theme=1 for light player (or omit for default)
                embedUrl = `http://googleusercontent.com/spotify.com/embed/${type}/${id}?utm_source=generator&theme=0`;
                statusDisplay.innerHTML = `Status: <span class="text-green-500 font-bold">Player Loaded!</span> You should hear music!`;
            } else if (query.length === 22 && /^[a-zA-Z0-9]+$/.test(query)) {
                // Assume 22-character alphanumeric string is a raw track ID
                embedUrl = `http://googleusercontent.com/spotify.com/embed/track/${query}?utm_source=generator&theme=0`;
                statusDisplay.innerHTML = `Status: <span class="text-green-500 font-bold">Player Loaded! (Assuming Track ID)</span> You should hear music!`;
            } else {
                // Not a recognized Spotify format
                statusDisplay.innerHTML = `Status: <span class="text-red-500 font-bold">Invalid link or ID.</span> Please use a full Spotify URL for a track, album, or playlist.`;
                return;
            }

            // Construct and inject the real Spotify iframe
            embedContainer.innerHTML = `
                <iframe style="border-radius:12px; width: 100%; height: 80px;" 
                    src="${embedUrl}" 
                    frameBorder="0" allowfullscreen="" 
                    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy">
                </iframe>
            `;
            searchInput.value = '';
        }
        window.startSpotifyPlayer = startSpotifyPlayer; // Expose globally


        /**
         * Checks if the input string is likely a URL.
         */
        function isValidUrl(string) {
            // Simple check: is it a common domain or does it look like a full URL?
            const domainRegex = /\.(com|org|net|dev|io|app|co|xyz|gov|edu)(\/|$)/i;
            const fullUrlRegex = /^(http|https):\/\/[^ "]+$/i;
            return fullUrlRegex.test(string) || domainRegex.test(string) || string.includes('://');
        }
        window.isValidUrl = isValidUrl; // Expose globally

        /**
         * Sets the developer status based on localStorage and updates UI.
         * @param {boolean} updateThemeSelector - Whether to force a refresh of the theme selector.
         */
        function checkDevStatus(updateThemeSelector = false) {
            if (isDevMode) {
                devPanelDiv.classList.remove('hidden');
                devStatusMessage.innerHTML = 'Status: <span class="text-green-500 font-bold">Activated (GOLD)</span>';

                // Devs get 999999 points (Simulated infinite points)
                window.userPoints = 999999; 

                if (updateThemeSelector) {
                    const goldenOption = themeSelector.querySelector('option[value="golden"]');
                    if (!goldenOption) {
                        const option = document.createElement('option');
                        option.value = 'golden';
                        option.textContent = 'Golden Theme (DEV ONLY)';
                        themeSelector.appendChild(option);
                    }
                }
            } else {
                devPanelDiv.classList.add('hidden');
                devStatusMessage.innerHTML = 'Status: <span class="text-gray-500 font-normal">Disabled</span>';
                
                // Reset points from stored value if Dev Mode is off
                window.userPoints = parseInt(localStorage.getItem('userPoints') || '100', 10);

                if (updateThemeSelector) {
                    const goldenOption = themeSelector.querySelector('option[value="golden"]');
                    if (goldenOption) {
                        goldenOption.remove();
                    }
                }
            }
            if (updateThemeSelector) {
                renderShop(); // Re-render the shop to update points/buttons based on dev status
            }
        }
        window.checkDevStatus = checkDevStatus; // Expose globally

        /**
         * Attempts to activate Dev Mode with a custom ID. (NEW)
         */
        function applyCustomId() {
            const input = document.getElementById('custom-dev-id-input');
            const id = input.value.trim().toUpperCase();

            if (DEV_IDS.includes(id)) {
                isDevMode = true;
                localStorage.setItem('isDevMode', 'true');
                checkDevStatus(true);
                devStatusMessage.innerHTML = 'Status: <span class="text-green-500 font-bold">Activated (GOLD)</span>. Restart to apply Dev Panel on main page.';
                input.value = '';
            } else {
                devStatusMessage.innerHTML = 'Status: <span class="text-red-500 font-bold">Invalid ID</span>. Try again.';
            }
        }
        window.applyCustomId = applyCustomId; // Expose globally

        /**
         * Opens the settings modal.
         */
        function openSettings() {
            loadSettings(); // Load current settings into the UI when opening
            settingsModal.classList.remove('hidden');
            settingsOverlay.classList.remove('hidden');
        }

        /**
         * Closes the settings modal.
         */
        function closeSettings() {
            settingsModal.classList.add('hidden');
            settingsOverlay.classList.add('hidden');
        }
        window.openSettings = openSettings; // Expose globally
        window.closeSettings = closeSettings; // Expose globally

        /**
         * Loads and applies saved settings.
         */
        function loadSettings() {
            // 1. User ID Display
            userIdDisplay.textContent = window.appId || 'SIMULATED-USER-1337';

            // 2. Load Theme and Dev Status
            checkDevStatus(true); // Must be called before setTheme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme, false); // Do not re-save theme when loading

            // 3. Load Site View Preference
            siteViewPreference = localStorage.getItem('siteViewPreference') || 'prompt';
            siteViewSelector.value = siteViewPreference;
        }

        /**
         * Sets and applies the custom theme.
         * @param {string} themeName - The name of the theme (e.g., 'dark', 'cyberpunk').
         * @param {boolean} save - Whether to save to localStorage (default true).
         */
        function setTheme(themeName, save = true) {
            // 1. Check ownership/permission
            const isDefault = ['light', 'dark', 'monochrome'].includes(themeName);
            const isOwned = ownedThemes.includes(themeName);
            const isGolden = themeName === 'golden' && isDevMode;
            const isPremiumTheme = themeName === PREMIUM_THEME_KEY && isPremium;

            if (!isDefault && !isOwned && !isGolden && !isPremiumTheme) {
                // Prevent setting a locked theme unless it's a default one
                alert(`Theme "${themeName.charAt(0).toUpperCase() + themeName.slice(1)}" is locked. Please purchase it in the shop.`);
                // Revert to the last saved theme
                themeName = localStorage.getItem('theme') || 'dark';
            }

            // 2. Remove all theme classes
            const allThemeClasses = ['dark-mode', 'monochrome-theme', 'golden-theme', PREMIUM_THEME_KEY + '-theme'];
            Object.keys(SHOP_ITEMS).forEach(key => {
                if (SHOP_ITEMS[key].type === 'theme') {
                    allThemeClasses.push(SHOP_ITEMS[key].themeKey + '-theme');
                }
            });
            document.body.classList.remove(...allThemeClasses);

            // 3. Apply the chosen theme class
            if (themeName === 'dark') {
                document.body.classList.add('dark-mode');
            } else if (themeName === 'monochrome') {
                document.body.classList.add('monochrome-theme');
            } else if (themeName === 'golden') {
                document.body.classList.add('golden-theme');
            } else if (themeName !== 'light') {
                // All other themes use the structure [themeName]-theme
                document.body.classList.add(themeName + '-theme');
            }

            // 4. Save
            if (save) {
                localStorage.setItem('theme', themeName);
            }

            // 5. Update selector (if available)
            if (themeSelector) {
                themeSelector.value = themeName;
            }
        }
        window.setTheme = setTheme; // Expose globally

        /**
         * Saves the site view preference.
         */
        function saveSiteViewPreference(preference) {
            siteViewPreference = preference;
            localStorage.setItem('siteViewPreference', preference);
        }
        window.saveSiteViewPreference = saveSiteViewPreference; // Expose globally

        // --- CLOCK AND TIMER LOGIC ---
        
        /**
         * Updates the live time display in the header.
         */
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            document.getElementById('live-clock').textContent = timeString;
        }

        /**
         * Sets a simple timer with a notification.
         */
        function setSimpleTimer() {
            const timerInput = document.getElementById('timer-input');
            const timerStatus = document.getElementById('timer-status');
            const minutes = parseInt(timerInput.value, 10);

            if (isNaN(minutes) || minutes <= 0) {
                timerStatus.textContent = "Please enter a valid number of minutes.";
                return;
            }

            // Clear any existing timer
            clearTimeout(timerTimeout);

            const ms = minutes * 60 * 1000;
            timerStatus.textContent = `Timer set for ${minutes} minute${minutes > 1 ? 's' : ''}!`;
            timerInput.value = '';

            timerTimeout = setTimeout(() => {
                // Play sound (Simulated)
                console.log("Timer finished sound");
                
                const modalMessage = `‚è∞ Time's up! Your ${minutes} minute timer has finished.`;
                alert(modalMessage); // Simple placeholder for alert replacement
                timerStatus.textContent = "Timer finished.";
            }, ms);
        }
        window.setSimpleTimer = setSimpleTimer; // Expose globally

        // --- MAIN SEARCH LOGIC ---

        /**
         * Main function to handle the search process.
         */
        async function performSearch() {
            const query = searchInput.value.trim();
            if (!query) {
                displayError("Please enter a search query or a website address.");
                return;
            }

            // Reset UI state
            resultsDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            directLinkDiv.classList.add('hidden');
            iframeViewerDiv.classList.add('hidden');
            loadingDiv.classList.add('hidden');
            searchButton.disabled = true;
            searchInput.disabled = true;
            summaryTextDiv.innerHTML = '';
            sourcesList.innerHTML = '';
            
            // Log the search query for Top Searches
            if (typeof window.logSearch === 'function') {
                window.logSearch(query);
            }

            // --- Step 2: Check for Direct URL Navigation ---
            if (window.isValidUrl(query)) {
                directLinkTextSpan.textContent = query;
                searchButton.disabled = false;
                searchInput.disabled = false;

                // If preference is 'newtab', open directly
                if (siteViewPreference === 'newtab') {
                    navigateToUrl(true);
                    return;
                } 
                // If preference is 'internal', try internal embed directly
                else if (siteViewPreference === 'internal') {
                    navigateToUrl(false);
                    return;
                }
                // If preference is 'prompt', show the direct link container
                else {
                    directLinkDiv.classList.remove('hidden');
                    return;
                }
            }

            // --- Step 3: Proceed with Mock Search (API disabled) ---
            await startLoadingEngine(query);

            // Once loading is done, show the results
            try {
                // Simulate processing time after loading (minimal delay)
                await new Promise(resolve => setTimeout(resolve, 500)); 

                // Use the mock response
                displayResults(MOCK_SUMMARY, MOCK_SOURCES);
                
                // Add points for a successful search
                if (!isDevMode) {
                    userPoints += 5;
                    localStorage.setItem('userPoints', userPoints.toString());
                }

            } catch (e) {
                displayError("Search failed due to a simulated API error. Try another query.");
            } finally {
                searchButton.disabled = false;
                searchInput.disabled = false;
                loadingDiv.classList.add('hidden');
                
                // Refresh Top Searches in the background
                if (window.loadTopSearches) {
                    window.loadTopSearches();
                }
            }
        }
        window.performSearch = performSearch; // Expose globally

        /**
         * Performs a search using a Top Search quick button.
         */
        window.performQuickSearch = function(queryText) {
            searchInput.value = queryText;
            performSearch();
        }

        /**
         * Handles navigating to a URL either in a new tab or internally.
         */
        function navigateToUrl(inNewTab) {
            let url = searchInput.value.trim();
            if (!url) return;

            // Ensure URL has a protocol if missing
            if (!url.match(/^(http|https):\/\//i)) {
                url = 'https://' + url;
            }

            if (inNewTab) {
                window.open(url, '_blank', 'noopener, noreferrer');
                // Hide prompt after opening
                directLinkDiv.classList.add('hidden');
            } else {
                // Attempt internal embedding
                searchFormContainer.classList.add('hidden');
                resultsDiv.classList.add('hidden');
                errorDiv.classList.add('hidden');
                devPanelDiv.classList.add('hidden');
                directLinkDiv.classList.add('hidden');
                iframeViewerDiv.classList.remove('hidden');
                externalIframe.src = url;
                externalLinkRetry.href = url;
                
                // Check if the iframe loaded (crude check via timeout)
                // This is a simulation, as real cross-origin blocking is instantaneous.
                document.getElementById('iframe-fallback').style.opacity = '0';
                const timer = setTimeout(() => {
                    // If the src is still 'about:blank' or a CORS error occurred (simulated)
                    // We simply display the fallback overlay to the user
                    document.getElementById('iframe-fallback').style.opacity = '1';
                }, 3000); // 3 seconds to check loading
                
                // Clear state when the user goes back to search
                window.resetToSearch = () => {
                    clearTimeout(timer); // Prevent fallback from appearing late
                    iframeViewerDiv.classList.add('hidden');
                    searchFormContainer.classList.remove('hidden');
                    document.getElementById('iframe-fallback').style.opacity = '0'; // Reset state
                    externalIframe.src = 'about:blank'; // Clear content
                    searchInput.focus();
                };
            }
        }
        window.navigateToUrl = navigateToUrl; // Expose globally

        /**
         * Simulates opening an internal link (used for Games section).
         */
        function openGameInternally(domain) {
            searchInput.value = domain;
            navigateToUrl(false);
        }
        window.openGameInternally = openGameInternally; // Expose globally
        
        /**
         * Controls the custom loading engine animation and time.
         */
        async function startLoadingEngine(query) {
            loadingEngineOverlay.classList.remove('hidden');
            
            // 1. Determine load time (Premium benefit)
            const totalLoadTime = isPremium ? PREMIUM_LOAD_TIME : STANDARD_LOAD_TIME;
            
            // 2. Randomize Concurrent Users (500 to 2000)
            const randomUsers = Math.floor(Math.random() * 1501) + 500;
            concurrentUsersSpan.textContent = randomUsers.toLocaleString();

            // 3. Random Tip
            const randomTip = TIPS[Math.floor(Math.random() * TIPS.length)];
            loadingTipP.textContent = randomTip;

            // 4. Emoji Animation (3 seconds)
            let emojiIndex = 0;
            loadingEmojiDiv.textContent = EMOJIS[emojiIndex];
            loadingEmojiDiv.classList.add('animate-pulse-once');
            
            clearInterval(emojiInterval); // Clear any old intervals
            emojiInterval = setInterval(() => {
                loadingEmojiDiv.classList.remove('animate-pulse-once');
                void loadingEmojiDiv.offsetWidth; // Force reflow/repaint to restart animation
                emojiIndex = (emojiIndex + 1) % EMOJIS.length;
                loadingEmojiDiv.textContent = EMOJIS[emojiIndex];
                loadingEmojiDiv.classList.add('animate-pulse-once');
            }, 3000);

            // 5. Countdown and Progress Bar
            let currentCountdown = totalLoadTime;
            const progressIncrement = 100 / (totalLoadTime * 10); // 10 increments per second (100ms)
            loadCountdownSpan.textContent = `${totalLoadTime}s`;
            loadProgressBar.style.width = '0%';
            
            let currentProgress = 0;
            clearInterval(countdownInterval); // Clear any old intervals
            countdownInterval = setInterval(() => {
                currentCountdown -= 0.1;
                currentProgress += progressIncrement;

                if (currentCountdown <= 0) {
                    currentCountdown = 0;
                    currentProgress = 100;
                    clearInterval(countdownInterval);
                }

                loadCountdownSpan.textContent = `${Math.ceil(currentCountdown)}s`;
                loadProgressBar.style.width = `${Math.min(100, currentProgress)}%`;
            }, 100);

            // 6. Set the timeout for when the loading is 'done'
            return new Promise(resolve => {
                clearTimeout(loadTimeout); // Clear any old timeouts
                loadTimeout = setTimeout(() => {
                    stopLoadingEngine();
                    resolve();
                }, totalLoadTime * 1000);
            });
        }

        /**
         * Stops the custom loading engine animation and hides the overlay.
         */
        function stopLoadingEngine() {
            clearInterval(countdownInterval);
            clearInterval(emojiInterval);
            clearTimeout(loadTimeout);
            loadingEngineOverlay.classList.add('hidden');
        }

        /**
         * Displays the search results summary and sources.
         */
        function displayResults(summary, sources) {
            summaryTextDiv.innerHTML = summary;
            resultsDiv.classList.remove('hidden');

            // NEW: Reset and enable feedback state
            feedbackMessage.classList.add('hidden');
            feedbackSection.classList.remove('hidden');
            feedbackSection.querySelectorAll('button').forEach(btn => btn.disabled = false);

            sourcesList.innerHTML = '';
            if (sources && sources.length > 0) {
                sources.forEach(source => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-start space-x-2';
                    listItem.innerHTML = `
                        <svg class="w-4 h-4 mt-1 flex-shrink-0 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.819l5.656-5.656a4 4 0 105.656 5.656l-4 4"></path></svg>
                        <a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="truncate">
                            ${source.title} <span class="text-xs text-gray-400">(${new URL(source.uri).hostname})</span>
                        </a>
                    `;
                    sourcesList.appendChild(listItem);
                });
            } else {
                sourcesList.innerHTML = '<li class="text-gray-400">No specific web sources found for grounding this answer.</li>';
            }
        }

        /**
         * Displays an error message in the dedicated error container.
         */
        function displayError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden'); 
            directLinkDiv.classList.add('hidden'); 
            iframeViewerDiv.classList.add('hidden'); 
            searchFormContainer.classList.remove('hidden'); 
        }

        // Set initial focus and initialize modes
        window.onload = () => {
             searchInput.focus();
             loadSettings(); // Load all settings (theme, dev status, etc.)
             updateClock(); // Initialize clock
             setInterval(updateClock, 1000); // Update clock every second
             
             // NEW: Initialize the chat listener
             if (typeof initChat === 'function') {
                 initChat();
             }
             
             // Call loadTopSearches ONLY after the entire DOM is ready.
             if(window.loadTopSearches) {
                 window.loadTopSearches(); 
             }
        };

    </script>
</body>
</html>