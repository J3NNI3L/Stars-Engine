<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- General and Light Mode Styles --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
            transition: background-color 0.3s, color 0.3s;
        }
        #main-content-card {
            background-color: #ffffff;
            border-color: #f3f4f6;
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s, transform 0.3s;
        }
        #iframe-viewer {
            height: 60vh;
            min-height: 400px;
        }
        .text-indigo-700 { color: #4338ca; }
        .bg-indigo-50 { background-color: #eef2ff; }
        
        /* --- Dark Mode Styles --- */
        body.dark-mode {
            background-color: #111827;
            color: #e5e7eb;
        }
        body.dark-mode #main-content-card {
            background-color: #1f2937;
            border-color: #374151;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .text-gray-500 { color: #9ca3af; }
        body.dark-mode .text-gray-800 { color: #f3f4f6; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
            background-color: #374151;
            border-color: #4b5563;
            color: #e5e7eb;
        }
        body.dark-mode input::placeholder, body.dark-mode textarea::placeholder { color: #9ca3af; }
        body.dark-mode .bg-gray-100 { background-color: #374151; }
        body.dark-mode .border-gray-200 { border-color: #4b5563; }
        body.dark-mode .border-gray-300 { border-color: #4b5563; }
        body.dark-mode .text-gray-700 { color: #d1d5db; }
        body.dark-mode .bg-indigo-50 { background-color: #3730a3; }
        body.dark-mode .text-gray-600 { color: #9ca3af; }
        body.dark-mode .hover\:bg-indigo-100:hover { background-color: #4f46e5; }
        body.dark-mode .hover\:bg-green-100:hover { background-color: #10b981; }

        /* --- Custom Theme: Monochrome --- */
        body.monochrome-theme {
            background-color: #000000;
            color: #cccccc;
            filter: grayscale(100%);
        }
        body.monochrome-theme #main-content-card {
            background-color: #1a1a1a;
            border-color: #555555;
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.1);
        }
        body.monochrome-theme .text-indigo-700 { color: #f0f0f0; }
        body.monochrome-theme .bg-indigo-600, body.monochrome-theme .bg-green-600 { 
            background-color: #444444; 
        }
        body.monochrome-theme .hover\:bg-indigo-700:hover, body.monochrome-theme .hover\:bg-green-700:hover { 
            background-color: #666666; 
        }
        body.monochrome-theme .bg-blue-100 { background-color: #333333; }
        body.monochrome-theme .text-blue-800 { color: #cccccc; }
        body.monochrome-theme input, body.monochrome-theme select, body.monochrome-theme textarea {
            background-color: #1a1a1a;
            border-color: #555555;
            color: #cccccc;
        }
        
        /* --- Custom Theme: Golden (CODE MODE ONLY) --- */
        body.golden-theme {
            background-color: #0d121c; /* Dark navy background */
            color: #fff;
        }
        body.golden-theme #main-content-card {
            background-color: #1a1f29; /* Slightly lighter card */
            border-color: #e3c46e; /* Gold border */
            box-shadow: 0 0 30px rgba(227, 196, 110, 0.5); /* Glowing gold shadow */
        }
        body.golden-theme .text-indigo-700 { color: #f5d76e; } /* Gold text */
        body.golden-theme .text-gray-800 { color: #f5d76e; }
        body.golden-theme .bg-indigo-600, body.golden-theme .bg-green-600 { 
            background-color: #e3c46e; /* Gold buttons */
            color: #0d121c;
        }
        body.golden-theme .hover\:bg-indigo-700:hover, body.golden-theme .hover\:bg-green-700:hover { 
            background-color: #f5d76e; 
            color: #0d121c;
        }
        body.golden-theme .bg-blue-100 { background-color: #444444; }
        body.golden-theme .text-blue-800 { color: #f5d76e; }
        body.golden-theme input, body.golden-theme select, body.golden-theme textarea {
            background-color: #2c3340;
            border-color: #e3c46e;
            color: #fff;
        }
        body.golden-theme .bg-indigo-50 { background-color: #3d4a60; border-color: #f5d76e; }
        body.golden-theme .text-gray-700 { color: #fff; }
        body.golden-theme .text-gray-600 { color: #d1d5db; }
        body.golden-theme .border-gray-200 { border-color: #374151; }
        
        /* --- NEW SHOP THEMES --- */
        
        /* PREMIUM Theme */
        body.premium-theme {
            background-color: #000000;
            color: #e0e0e0;
        }
        body.premium-theme #main-content-card {
            background-color: #0a0a0a;
            border-color: #c0c0c0;
            box-shadow: 0 0 40px rgba(192, 192, 192, 0.2);
        }
        body.premium-theme .text-indigo-700 { color: #c0c0c0; }
        body.premium-theme .bg-indigo-600, body.premium-theme .bg-green-600 {
            background-color: #333333;
            color: #e0e0e0;
            border: 1px solid #666666;
        }
        body.premium-theme input, body.premium-theme select, body.premium-theme textarea {
            background-color: #1a1a1a;
            border-color: #666666;
            color: #e0e0e0;
        }

        /* 1. Cyberpunk Theme */
        body.cyberpunk-theme {
            background-color: #150025;
            color: #00ffff;
        }
        body.cyberpunk-theme #main-content-card {
            background-color: #2a004a;
            border-color: #ff0099;
            box-shadow: 0 0 25px rgba(255, 0, 153, 0.5);
        }
        body.cyberpunk-theme .text-indigo-700 { color: #ff0099; }
        body.cyberpunk-theme .bg-indigo-600, body.cyberpunk-theme .bg-green-600 {
            background-color: #ff0099;
            color: #150025;
            text-shadow: 0 0 3px #00ffff;
        }
        body.cyberpunk-theme input, body.cyberpunk-theme select, body.cyberpunk-theme textarea {
            background-color: #330066;
            border-color: #00ffff;
            color: #00ffff;
        }
        body.cyberpunk-theme .bg-indigo-50 { background-color: #330066; border-color: #ff0099; }
        body.cyberpunk-theme .text-gray-700 { color: #00ffff; }
        body.cyberpunk-theme .text-gray-600 { color: #9933ff; }

        /* 2. Ocean Theme */
        body.ocean-theme {
            background-color: #e0f7fa;
            color: #006064;
        }
        body.ocean-theme #main-content-card {
            background-color: #ffffff;
            border-color: #80deea;
            box-shadow: 0 5px 15px rgba(0, 151, 167, 0.2);
        }
        body.ocean-theme .text-indigo-700 { color: #00bcd4; }
        body.ocean-theme .bg-indigo-600, body.ocean-theme .bg-green-600 {
            background-color: #00acc1;
            color: #ffffff;
        }
        body.ocean-theme input, body.ocean-theme select, body.ocean-theme textarea {
            background-color: #f8ffff;
            border-color: #4dd0e1;
            color: #006064;
        }
        body.ocean-theme .bg-indigo-50 { background-color: #b2ebf2; border-color: #0097a7; }

        /* 3. Forest Theme */
        body.forest-theme {
            background-color: #f0f8e9;
            color: #1b5e20;
        }
        body.forest-theme #main-content-card {
            background-color: #ffffff;
            border-color: #81c784;
            box-shadow: 0 5px 15px rgba(27, 94, 32, 0.1);
        }
        body.forest-theme .text-indigo-700 { color: #388e3c; }
        body.forest-theme .bg-indigo-600, body.forest-theme .bg-green-600 {
            background-color: #4caf50;
            color: #ffffff;
        }
        body.forest-theme input, body.forest-theme select, body.forest-theme textarea {
            background-color: #f7fcf7;
            border-color: #a5d6a7;
            color: #1b5e20;
        }
        body.forest-theme .bg-indigo-50 { background-color: #c8e6c9; border-color: #43a047; }

        /* 4. Sunset Theme */
        body.sunset-theme {
            background-color: #ffe0b2;
            color: #d84315;
        }
        body.sunset-theme #main-content-card {
            background: linear-gradient(145deg, #fff3e0, #ffccbc);
            border-color: #ff7043;
            box-shadow: 0 10px 20px rgba(255, 87, 34, 0.3);
        }
        body.sunset-theme .text-indigo-700 { color: #f4511e; }
        body.sunset-theme .bg-indigo-600, body.sunset-theme .bg-green-600 {
            background-color: #ff8a65;
            color: #8d1c02;
        }
        body.sunset-theme input, body.sunset-theme select, body.sunset-theme textarea {
            background-color: #fff8e1;
            border-color: #ffab91;
            color: #d84315;
        }
        body.sunset-theme .bg-indigo-50 { background-color: #ffab91; border-color: #d84315; }

        /* 5. Classic Theme */
        body.classic-theme {
            background-color: #f0f4f8;
            color: #102a43;
        }
        body.classic-theme #main-content-card {
            background-color: #ffffff;
            border-color: #d9e2ec;
            box-shadow: 0 5px 10px rgba(16, 42, 67, 0.1);
        }
        body.classic-theme .text-indigo-700 { color: #52668c; }
        body.classic-theme .bg-indigo-600, body.classic-theme .bg-green-600 {
            background-color: #4a69bd;
            color: #ffffff;
        }
        body.classic-theme input, body.classic-theme select, body.classic-theme textarea {
            background-color: #ffffff;
            border-color: #b8c4d4;
            color: #102a43;
        }
        body.classic-theme .bg-indigo-50 { background-color: #ebf4f8; border-color: #4a69bd; }


        /* --- Fullscreen Simulation Styles (FIX) --- */
        body.fullscreen-active {
            padding: 0 !important;
            margin: 0 !important;
            overflow: hidden;
        }
        .fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw !important;
            max-width: 100vw !important;
            height: 100vh;
            margin: 0 !important;
            padding: 2rem !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            z-index: 100;
            overflow-y: auto;
        }
        .fullscreen-mode #iframe-viewer {
             height: calc(100vh - 150px);
             min-height: auto;
        }

        /* --- Custom Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes scaleUp {
            from { opacity: 0.5; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .animate-scale-up {
            animation: scaleUp 0.5s ease-out;
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        /* New: Emoji Animation Keyframes */
        @keyframes pulse-once {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pulse-once {
            animation: pulse-once 0.5s ease-out;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center p-4 sm:p-8">

    
    <div id="main-content-card" class="w-full max-w-2xl bg-white p-6 sm:p-10 rounded-xl shadow-2xl border border-gray-100 mt-10 animate-scale-up">

        <header class="text-center mb-8 relative">
            
            <div class="absolute top-0 left-0 pt-2 pl-4 text-sm font-semibold text-gray-700 dark:text-gray-300" id="live-clock"></div>
            
            <div class="text-4xl font-extrabold text-indigo-700 dark:text-indigo-400">Starz</div>
            <p class="text-gray-500 mt-2">Not on Steam!</p>
            
            <div class="absolute top-0 right-0 flex space-x-2">
                
                <button onclick="toggleChat()" class="p-2 text-gray-400 hover:text-indigo-600 transition duration-300 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Community Chat">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 4v-4z" />
                    </svg>
                </button>
                
                <button
                    id="settings-button"
                    onclick="openSettings()"
                    class="p-2 text-gray-400 hover:text-indigo-600 transition duration-300 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"
                    title="Settings"
                >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.536.27.81.543 1.066 2.572z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </div>
        </header>
        
        <div id="iframe-viewer" class="hidden w-full mt-8">
            <button
                id="back-button"
                onclick="resetToSearch()"
                class="mb-4 px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold rounded-lg shadow-sm hover:bg-gray-300 dark:hover:bg-gray-500 transition duration-300 ease-in-out"
            >
                ‚Üê Back to Home
            </button>
            <div class="h-full border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden bg-gray-100 dark:bg-gray-800 relative">
                <iframe 
                    id="external-iframe" 
                    class="w-full h-full" 
                    src="about:blank"
                    sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-modals"
                ></iframe>
                <div id="iframe-fallback" class="absolute inset-0 p-6 text-center text-gray-500 flex flex-col items-center justify-center pointer-events-none transition duration-500 opacity-0">
                    <svg class="w-8 h-8 text-red-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p class="font-bold">Cannot display site.</p>
                    <p class="mt-1 text-sm">This website may block embedding (security policy).</p>
                    <a id="external-link-retry" href="#" target="_blank" rel="noopener noreferrer" class="mt-3 text-indigo-600 hover:underline text-sm font-medium pointer-events-auto transition duration-300">Click here to open in a new tab.</a>
                </div>
            </div>
        </div>

        <div id="search-form-container">
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                
                <datalist id="search-suggestions">
                    <option value="Latest AI News"></option>
                    <option value="Firebase Setup Tutorial"></option>
                    <option value="Starz Shop Themes"></option>
                    <option value="cloudmoonapp.com"></option>
                    <option value="What is Tailwind CSS?"></option>
                </datalist>

                <input
                    id="search-input"
                    type="text"
                    placeholder="Ask anything, e.g., 'What are the latest discoveries in AI?' or 'cloudmoonapp.com'"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-300 ease-in-out dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                    onkeypress="if(event.key === 'Enter') performSearch()"
                    list="search-suggestions"
                >
                <button
                    id="search-button"
                    onclick="performSearch()"
                    class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-300 ease-in-out disabled:opacity-50"
                >
                    Search
                </button>
            </div>

            <div id="timer-section" class="mt-4 flex space-x-2 items-center">
                <input 
                    id="timer-input" 
                    type="number" 
                    placeholder="Set timer (mins)" 
                    min="1"
                    class="w-32 p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                >
                <button
                    onclick="setSimpleTimer()"
                    class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-300 ease-in-out"
                >
                    Set Timer
                </button>
                <span id="timer-status" class="text-sm font-medium text-green-700 dark:text-green-400"></span>
            </div>
            
            <div id="direct-link-container" class="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg shadow-sm hidden dark:bg-yellow-900 dark:border-yellow-700 animate-fade-in">
                <p class="text-sm font-medium text-yellow-800 dark:text-yellow-200 mb-2">Did you mean to go directly to this site? (Recommended: Open in New Tab)</p>
                <button
                    onclick="navigateToUrl(true)" 
                    class="text-sm px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 ease-in-out"
                >
                    Open in New Tab
                </button>
                <button
                    id="direct-link-button"
                    onclick="navigateToUrl(false)" 
                    class="text-sm px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition duration-300 ease-in-out ml-2"
                >
                    Try viewing <span id="direct-link-text" class="font-bold"></span> internally (May be blocked)
                </button>
            </div>
        </div>
        
        <div id="dev-panel" class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 hidden animate-fade-in">
            <h3 class="text-xl font-bold text-red-600 dark:text-red-400 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                Panel: DEV STATUS
            </h3>
            <div class="space-y-3">
                <p class="text-sm text-gray-700 dark:text-gray-300">Welcome, Developer! Your custom ID has been activated. You now have access to the **Golden Theme** in settings.</p>
                <button class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 ease-in-out">
                    Access Debug Logs (WIP)
                </button>
                <button onclick="localStorage.clear(); location.reload();" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition duration-300 ease-in-out">
                    Clear Local Storage (Hard Reset)
                </button>
            </div>
        </div>
        
        <div class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Top Searches Today
                <span id="loading-searches" class="hidden ml-3 text-sm text-gray-500">Loading...</span>
            </h3>
            <div id="top-searches" class="flex flex-wrap gap-2 min-h-[40px] items-center">
                <p id="no-searches-message" class="text-gray-400 text-sm hidden">Start searching to see popular topics!</p>
                </div>
        </div>
        
        <div class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-6">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Games
            </h3>
            <div id="games-section" class="grid grid-cols-2 gap-4 sm:grid-cols-4">
                <a href="javascript:void(0)" onclick="openGameInternally('cloudmoonapp.com')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-300 ease-in-out border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-green-900">
                    Cloud Moon App
                </a>
                <a href="javascript:void(0)" onclick="openGameInternally('play.geforcenow.com')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-300 ease-in-out border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-green-900">
                    GeForce NOW
                </a>
                <a href="javascript:void(0)" onclick="openGameInternally('poki.com')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-300 ease-in-out border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-green-900">
                    Poki (Web Games)
                </a>
                <a href="javascript:void(0)" onclick="openGameInternally('krunker.io')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-300 ease-in-out border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-green-900">
                    Krunker.io
                </a>
                <a href="javascript:void(0)" onclick="openGameInternally('agar.io')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-300 ease-in-out border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-green-900">
                    Agar.io
                </a>
                <a href="javascript:void(0)" onclick="openGameInternally('coolmathgames.com')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-300 ease-in-out border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-green-900">
                    Cool Math Games
                </a>
                <a href="javascript:void(0)" onclick="openNotepad()" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-indigo-100 transition duration-300 ease-in-out border border-gray-200 text-sm font-medium text-gray-700 hover:text-indigo-800 shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-indigo-900">
                    Notepad üìù
                </a>
            </div>
        </div>

        <div id="loading" class="hidden text-center mt-6 text-indigo-600 font-medium">
            <div class="flex items-center justify-center space-x-2">
                <svg class="animate-spin h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Searching...</span>
            </div>
        </div>

        <div id="results" class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 hidden animate-fade-in">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Search Result</h2>

            <div id="summary-text" class="p-5 bg-indigo-50 border-l-4 border-indigo-600 rounded-r-lg text-lg text-gray-700 leading-relaxed shadow-sm dark:bg-indigo-900 dark:text-gray-100">
                </div>

            <div id="feedback-section" class="mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg flex justify-between items-center animate-fade-in">
                <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">Was this result helpful? Rate it!</p>
                <div class="flex space-x-2">
                    <button onclick="submitFeedback('like')" title="Upvote (+10 Points)" class="p-2 bg-green-500 text-white rounded-full hover:bg-green-600 transition duration-300 transform hover:scale-110">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0...
                    </button>
                    <button onclick="submitFeedback('dislike')" title="Downvote (-2 Points)" class="p-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition duration-300 transform hover:scale-110">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 017.764 4h7.585m-1.25 10l-1.6 2.5a2 2 0 00.17 2.94l1.192 1.341a.5.5 0 00.865-.38V14z"></path></svg>
                    </button>
                </div>
            </div>
            
            <div id="feedback-message" class="mt-2 text-sm font-medium text-center text-green-600 dark:text-green-400 hidden animate-fade-in"></div>

            <div class="mt-6">
                <h3 class="text-sm font-semibold uppercase text-gray-500 dark:text-gray-400 mb-2">Sources</h3>
                <ul id="sources-list" class="space-y-2 text-sm">
                </ul>
            </div>
        </div>

        <div id="error-message" class="hidden mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg dark:bg-red-900 dark:border-red-700 dark:text-red-200 animate-fade-in">
            An error occurred. Please try again.
        </div>
    </div>
    
    <div id="notepad-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 hidden" onclick="closeNotepad()"></div>
    <div id="notepad-modal" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-xl bg-white p-6 sm:p-8 rounded-xl shadow-2xl z-50 hidden dark:bg-gray-800 animate-scale-up">
        <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-6 border-b pb-4 flex justify-between items-center">
            My Notes üìù
            <button onclick="closeNotepad()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </h2>
        <textarea 
            id="notepad-text-area" 
            rows="15" 
            placeholder="Write down your search ideas, secret gold IDs, or reminders here. Your notes are saved automatically!" 
            class="w-full p-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-inner dark:bg-gray-700 dark:border-gray-600 dark:text-white resize-none"
            oninput="saveNotepadContent()"
        ></textarea>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Notes are saved automatically to your local device.</p>
    </div>

    <div id="settings-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 hidden" onclick="closeSettings()"></div>
    <div id="settings-modal" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-lg bg-white p-6 sm:p-8 rounded-xl shadow-2xl z-50 hidden dark:bg-gray-800 animate-scale-up">
        <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-6 border-b pb-4 flex justify-between items-center">
            Settings
            <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </h2>

        <div class="space-y-6 max-h-[70vh] overflow-y-auto pr-3">
            
            <div class="pb-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2">User Profile</h3>
                <p class="text-sm text-gray-700 dark:text-gray-300">User ID: <span id="user-id-display" class="font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">...</span></p>
                <p class="text-sm text-gray-700 dark:text-gray-300 mt-1">Current Points: <span id="points-display" class="font-bold text-indigo-600 dark:text-indigo-400">...</span></p>
            </div>

            <div class="pb-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2">Music Player (YouTube Music)</h3>
                <p id="music-player-status" class="text-sm text-gray-500 dark:text-gray-400 mb-3">Status: Not playing</p>
                
                <div id="musicPlayerControl" class="flex flex-col space-y-4">
                    <div class="flex space-x-2">
                        <input type="text" id="musicUrlInput" class="flex-grow p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150 dark:bg-gray-700 dark:border-gray-600 dark:text-white" 
                               placeholder="Paste YouTube Video/Playlist URL or ID (e.g., PL... or M7lc1UVf-VE)">
                        <button onclick="loadYouTubePlayer()" 
                                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md font-semibold">
                            Load Music
                        </button>
                    </div>
                    
                    <div id="playerEmbedContainer" class="w-full mt-4 rounded-lg overflow-hidden min-h-[80px] border border-gray-300 dark:border-gray-700">
                        <p id="playerPlaceholder" class="text-center text-gray-500 py-10">
                            Enter a YouTube URL or ID above to start listening.
                        </p>
                    </div>
                </div>
                </div>

            <div class="pb-4 border-b border-gray-200 dark:border-gray-700">
                <label for="theme-selector" class="block text-lg font-bold text-gray-800 dark:text-white mb-2">Custom Theme</label>
                <select id="theme-selector" onchange="setTheme(this.value)" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="light">Light Mode (Default)</option>
                    <option value="dark">Dark Mode (Default)</option>
                    <option value="monochrome">Monochrome Theme (Default)</option>
                </select>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Locked themes will be greyed out if you do not own them.
                </p>
            </div>

            <div class="pb-4 border-b border-gray-200 dark:border-gray-700">
                <label for="volume-slider" class="block text-lg font-bold text-gray-800 dark:text-white mb-2">Volume (WIP)</label>
                <input type="range" id="volume-slider" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400 mt-1">
                    <span>Mute</span>
                    <span>50%</span>
                    <span>Max</span>
                </div>
            </div>

            <div class="pb-4 border-b border-gray-200 dark:border-gray-700">
                <label for="site-view-selector" class="block text-lg font-bold text-gray-800 dark:text-white mb-2">External Link Handling</label>
                <select id="site-view-selector" onchange="saveSiteViewPreference(this.value)" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="prompt">Ask me every time (Default)</option>
                    <option value="internal">Always try internal viewer</option>
                    <option value="newtab">Always open in new tab</option>
                </select>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    How should the app handle websites you search for (e.g., cloudmoonapp.com)?
                </p>
            </div>
            
            <div id="shop-section" class="pb-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Starz Shop ‚ú®</h3>
                <div id="shop-items-container" class="space-y-4">
                    </div>
            </div>

            <div class="pb-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Developer Mode</h3>
                <p id="dev-status-message" class="text-sm text-gray-700 dark:text-gray-300 mb-2">Status: <span class="text-gray-500 font-normal">Disabled</span></p>
                <div class="flex space-x-2">
                    <input type="text" id="custom-dev-id-input" placeholder="Enter Custom Dev ID" class="flex-grow p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" >
                    <button onclick="applyCustomId()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 ease-in-out">
                        Activate
                    </button>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Activating Dev Mode unlocks secret features and infinite points.
                </p>
            </div>
        </div>

    </div>

    <div id="chat-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 hidden" onclick="toggleChat()"></div>
    <div id="chat-modal" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-sm h-full max-h-[80vh] bg-white p-4 rounded-xl shadow-2xl z-50 hidden dark:bg-gray-800 flex flex-col animate-scale-up">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 border-b pb-2 flex justify-between items-center">
            Community Chat
            <button onclick="toggleChat()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </h2>
        <div id="chat-messages" class="flex-grow overflow-y-auto space-y-3 mb-4 p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div id="chat-status" class="text-center text-sm text-gray-500 dark:text-gray-400">
                Loading chat...
            </div>
        </div>
        <form id="message-form" class="flex space-x-2">
            <input type="text" id="message-input" placeholder="Type a message..." required class="flex-grow p-3 text-sm bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" />
            <button type="submit" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition font-semibold">Send</button>
        </form>
    </div>

    <div id="loading-engine-overlay" class="fixed inset-0 bg-white dark:bg-gray-900 bg-opacity-95 dark:bg-opacity-95 backdrop-blur-sm z-[110] hidden flex flex-col items-center justify-center p-8 animate-fade-in">
        <div class="max-w-md w-full text-center">
            <div id="loading-emoji" class="text-6xl mb-6">üîç</div>
            <h2 class="text-3xl font-extrabold text-indigo-700 dark:text-indigo-400 mb-4">
                 Loading you in...
            </h2>
            <p class="text-lg text-gray-700 dark:text-gray-300 mb-6">
                Estimated time: <span id="load-countdown" class="font-bold text-red-500">15s</span>
            </p>
            <div class="w-3/4 mx-auto bg-gray-700 rounded-full h-2.5 mb-8">
                <div id="load-progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>

            <div class="p-4 bg-gray-800 rounded-lg border border-gray-700 shadow-lg animate-fade-in">
                <p class="text-xs font-semibold uppercase text-gray-400 mb-2">System Status</p>
                <p class="text-sm text-gray-300">Concurrent Users: <span id="concurrent-users" class="font-bold text-indigo-400">2000</span></p>
                <p class="text-sm text-gray-300 mt-1">Status: <span id="loading-tip" class="text-green-400">Applying latest theme update...</span></p>
            </div>
            
        </div>
    </div>


    <script type="text/javascript">
        // --- CONSTANTS ---
        const APP_VERSION = '1.0.1';
        const APP_ID = 'STARZ-TEST-001';
        const PREMIUM_THEME_KEY = 'premium';
        const STANDARD_LOAD_TIME = 15; // seconds
        const PREMIUM_LOAD_TIME = 5; // seconds
        const DEV_IDS = ['STARZ-GOLD-1337', '67']; // List of valid Developer IDs
        const TIPS = [
            "Yuh", 
            "What is this diddy blud doin?", 
            "Mr Beast Gimme some money, Yeahhhhh.", 
            "I quit. I hate this job.", 
            "Dude did u see the math homework, crazy right?", 
            "USE CODE 67!!!"
        ];
        const EMOJIS = ['üöÄ', '‚ú®', 'üí°', 'üîç', '‚≠ê', 'üß†'];
        const SHOP_ITEMS = {
            'premium_membership': { name: 'Premium Membership [25% OFF]', cost: 425, type: 'membership', themeKey: PREMIUM_THEME_KEY, description: 'Faster loading (5s), exclusive theme, and a lifetime code. (1-time purchase)' },
            'cyberpunk': { name: 'Cyberpunk Theme', cost: 150, type: 'theme', themeKey: 'cyberpunk', description: 'Neon aesthetic with bright accents.' },
            'ocean': { name: 'Ocean Theme', cost: 150, type: 'theme', themeKey: 'ocean', description: 'Calm blues and whites.' },
            'forest': { name: 'Forest Theme', cost: 150, type: 'theme', themeKey: 'forest', description: 'Earthy greens and browns.' },
            'sunset': { name: 'Sunset Theme', cost: 150, type: 'theme', themeKey: 'sunset', description: 'Warm orange and pink tones.' },
            'classic': { name: 'Classic Theme', cost: 150, type: 'theme', themeKey: 'classic', description: 'Professional blue and grey palette.' }
        };
        
        // State variables
        window.userPoints = parseInt(localStorage.getItem('userPoints') || '100', 10);
        let ownedThemes = JSON.parse(localStorage.getItem('ownedThemes') || '[]');
        let isPremium = localStorage.getItem('isPremium') === 'true';
        let isDevMode = localStorage.getItem('isDevMode') === 'true';
        let siteViewPreference = localStorage.getItem('siteViewPreference') || 'prompt'; // 'prompt', 'internal', or 'newtab'
        let timerTimeout;
        let countdownInterval;
        let loadTimeout;
        let emojiInterval;

        // --- MOCK API RESPONSE (Used when no actual search tool is available) ---
        const MOCK_SUMMARY = "The latest advancements in AI are primarily focused on large language models (LLMs) and generative adversarial networks (GANs). Recent breakthroughs include the development of models with trillions of parameters, significantly improving coherence and contextual understanding in text generation. Additionally, new training techniques are making these powerful models more accessible and efficient for broader applications across various industries, from finance to creative arts.";
        const MOCK_SOURCES = [
            { url: 'https://www.nature.com/articles/ai-llm-breakthroughs', title: 'Nature: LLMs and the Future of AI' },
            { url: 'https://ieeexplore.ieee.org/document/gan-efficiency', title: 'IEEE: Efficient Training of GANs' },
            { url: 'https://techcrunch.com/2024/09/generative-ai-in-finance/', title: 'TechCrunch: Generative AI in Finance' },
            { url: 'https://mitpress.mit.edu/books/web-customization', title: 'MIT Press: The New Era of Web Customization and Theming' }
        ];

        // --- UI Element References ---
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const loadingDiv = document.getElementById('loading');
        const resultsDiv = document.getElementById('results');
        const summaryTextDiv = document.getElementById('summary-text');
        const sourcesList = document.getElementById('sources-list');
        const errorDiv = document.getElementById('error-message');
        const searchFormContainer = document.getElementById('search-form-container');
        const mainContentCard = document.getElementById('main-content-card');
        const devPanelDiv = document.getElementById('dev-panel');
        // UI References for direct link/iframe
        const directLinkDiv = document.getElementById('direct-link-container');
        const directLinkTextSpan = document.getElementById('direct-link-text');
        const iframeViewerDiv = document.getElementById('iframe-viewer');
        const externalIframe = document.getElementById('external-iframe');
        const externalLinkRetry = document.getElementById('external-link-retry');
        // UI References for Settings Modal
        const settingsModal = document.getElementById('settings-modal');
        const settingsOverlay = document.getElementById('settings-modal-overlay');
        const userIdDisplay = document.getElementById('user-id-display');
        const themeSelector = document.getElementById('theme-selector');
        const siteViewSelector = document.getElementById('site-view-selector');
        const devStatusMessage = document.getElementById('dev-status-message');
        // NEW SHOP References
        const shopItemsContainer = document.getElementById('shop-items-container');
        const pointsDisplay = document.getElementById('points-display');
        // UI References for Notepad
        const notepadModal = document.getElementById('notepad-modal');
        const notepadOverlay = document.getElementById('notepad-modal-overlay');
        const notepadTextArea = document.getElementById('notepad-text-area');
        // UI References for Feedback
        const feedbackSection = document.getElementById('feedback-section');
        const feedbackMessage = document.getElementById('feedback-message');
        // UI References for Loading Engine
        const loadingEngineOverlay = document.getElementById('loading-engine-overlay');
        const loadCountdownSpan = document.getElementById('load-countdown');
        const loadProgressBar = document.getElementById('load-progress-bar');
        const concurrentUsersSpan = document.getElementById('concurrent-users');
        const loadingTipP = document.getElementById('loading-tip');
        const loadingEmojiDiv = document.getElementById('loading-emoji');

        // --- FIREBASE MOCK/SIMULATION (To support `logSearch` and `loadTopSearches`) ---
        let db; // Simulated Firestore instance placeholder.

        // Simulates the initialization of the Firebase App and Firestore (or its V8/V9 global functions).
        window.initializeFirebaseSimulation = function() {
            try {
                // Since we cannot run external scripts, we check for a global mock or skip.
                if (typeof window.firebase !== 'undefined' && typeof window.firebase.initializeApp === 'function') {
                    // Actual Firebase is available (not expected in this environment, but good practice)
                    const app = firebase.initializeApp({ /* config */ });
                    db = firebase.firestore();
                    console.log("Using real (or mocked) Firebase.");
                } else {
                    // Use a simple LocalStorage mock for Top Searches and Chat
                    console.log("Using LocalStorage/Internal Mock for Firebase features.");
                    db = {
                        collection: (path) => ({
                            add: async (data) => {
                                // Mock add operation for searches or chat
                                let items = JSON.parse(localStorage.getItem(path) || '[]');
                                items.push({...data, id: Date.now().toString()});
                                localStorage.setItem(path, JSON.stringify(items));
                            },
                            orderBy: (field, direction) => ({
                                limit: (count) => ({
                                    get: async () => {
                                        // Mock get operation for searches
                                        let items = JSON.parse(localStorage.getItem(path) || '[]');
                                        items.sort((a, b) => {
                                            if (direction === 'desc') return b[field] - a[field];
                                            return a[field] - b[field];
                                        });
                                        // Simple frequency counting for top searches
                                        const queryCounts = {};
                                        items.forEach(item => {
                                            queryCounts[item.query] = (queryCounts[item.query] || 0) + 1;
                                        });
                                        
                                        const sortedQueries = Object.keys(queryCounts)
                                            .sort((a, b) => queryCounts[b] - queryCounts[a])
                                            .slice(0, count);

                                        return {
                                            docs: sortedQueries.map(query => ({
                                                data: () => ({ query: query, count: queryCounts[query] })
                                            }))
                                        };
                                    }
                                })
                            })
                        })
                    };
                }
            } catch (error) {
                console.warn("Firebase/Mock Initialization failed. Some features (Chat, Top Searches) may be unavailable.", error);
            }
        };

        // Initialize Firebase mock on load
        initializeFirebaseSimulation();


        // --- CHAT LOGIC (Simplified Mock) ---
        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatModal = document.getElementById('chat-modal');
        const chatOverlay = document.getElementById('chat-modal-overlay');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const CHAT_STORAGE_KEY = `/artifacts/${APP_ID}/public/data/chat_messages`;

        function initChat() {
            loadChatMessages();
            messageForm.addEventListener('submit', handleMessageSubmit);
            // Simulate receiving new messages every 5 seconds
            setInterval(simulateIncomingMessage, 5000);
        }

        function toggleChat() {
            const isHidden = chatModal.classList.contains('hidden');
            if (isHidden) {
                chatModal.classList.remove('hidden');
                chatOverlay.classList.remove('hidden');
                loadChatMessages();
                messageInput.focus();
            } else {
                chatModal.classList.add('hidden');
                chatOverlay.classList.add('hidden');
            }
        }

        function loadChatMessages() {
            const messages = JSON.parse(localStorage.getItem(CHAT_STORAGE_KEY) || '[]');
            chatMessagesDiv.innerHTML = '<div id="chat-status" class="text-center text-sm text-gray-500 dark:text-gray-400">Welcome to the chat!</div>'; // Clear and reset status
            
            messages.forEach(msg => {
                displayMessage(msg.user, msg.text, msg.isSelf);
            });
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom
        }

        function handleMessageSubmit(event) {
            event.preventDefault();
            const text = messageInput.value.trim();
            if (text) {
                // Simulate sending message
                const newMessage = { user: 'You', text: text, isSelf: true, timestamp: Date.now() };
                saveMessage(newMessage);
                displayMessage(newMessage.user, newMessage.text, newMessage.isSelf);
                messageInput.value = '';
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                // Simulate a generic response after a delay
                setTimeout(() => simulateIncomingMessage(), 2000);
            }
        }

        function saveMessage(msg) {
            const messages = JSON.parse(localStorage.getItem(CHAT_STORAGE_KEY) || '[]');
            messages.push(msg);
            // Keep only the last 50 messages
            localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(messages.slice(-50))); 
        }

        function displayMessage(user, text, isSelf) {
            const messageElement = document.createElement('div');
            const userClass = isSelf ? 'justify-end' : 'justify-start';
            const bubbleClass = isSelf ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 rounded-tl-none';
            const userText = isSelf ? 'You' : user;
            
            messageElement.className = `flex ${userClass} animate-fade-in`;
            messageElement.innerHTML = `
                <div class="max-w-[70%] p-3 rounded-xl shadow-md ${bubbleClass}">
                    <p class="text-xs font-semibold mb-1 ${isSelf ? 'text-indigo-200' : 'text-gray-600 dark:text-gray-400'}">${userText}</p>
                    <p class="text-sm">${text}</p>
                </div>
            `;
            // Remove the initial status message if it's there
            const status = document.getElementById('chat-status');
            if (status) status.remove();

            chatMessagesDiv.appendChild(messageElement);
        }

        function simulateIncomingMessage() {
            if (chatModal.classList.contains('hidden')) return; // Don't simulate if chat is closed

            const BOT_MESSAGES = [
                "Hey, does anyone have the code 67?",
                "This Golden Theme is awesome!",
                "Trying to find a new game to play in the iframe...",
                "The server latency feels pretty good today.",
                "Starz is better than Steam, change my mind."
            ];
            const BOT_NAMES = ['CodeMaster', 'ThemeLover', 'GamerStar', 'LowLatencyGuy', 'StarzFan'];

            const text = BOT_MESSAGES[Math.floor(Math.random() * BOT_MESSAGES.length)];
            const user = BOT_NAMES[Math.floor(Math.random() * BOT_NAMES.length)];
            
            const newMessage = { user: user, text: text, isSelf: false, timestamp: Date.now() };
            saveMessage(newMessage);
            displayMessage(newMessage.user, newMessage.text, newMessage.isSelf);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        // Expose to the global scope
        window.initChat = initChat;
        window.toggleChat = toggleChat;

        // --- NEW NOTEPAD LOGIC ---
        function openNotepad() {
            notepadTextArea.value = localStorage.getItem('notepadContent') || '';
            notepadModal.classList.remove('hidden');
            notepadOverlay.classList.remove('hidden');
            notepadTextArea.focus();
        }
        window.openNotepad = openNotepad;

        function closeNotepad() {
            notepadModal.classList.add('hidden');
            notepadOverlay.classList.add('hidden');
        }
        window.closeNotepad = closeNotepad;

        function saveNotepadContent() {
            localStorage.setItem('notepadContent', notepadTextArea.value);
        }
        window.saveNotepadContent = saveNotepadContent;

        // --- NEW FEEDBACK LOGIC ---
        function submitFeedback(type) {
            // Disable buttons immediately to prevent spamming
            feedbackSection.querySelectorAll('button').forEach(btn => btn.disabled = true);

            if (isDevMode) {
                feedbackMessage.textContent = `Thanks, Dev! Feedback (${type}) logged to your simulated dashboard.`;
            } else {
                if (type === 'like') {
                    userPoints += 10;
                    localStorage.setItem('userPoints', userPoints.toString());
                    feedbackMessage.textContent = `Thanks for the "Like"! You earned 10 points. Current points: ${getPointsDisplay()}`;
                } else {
                    userPoints = Math.max(0, userPoints - 2);
                    localStorage.setItem('userPoints', userPoints.toString());
                    feedbackMessage.textContent = `Feedback received. We'll use this to improve! (-2 points). Current points: ${getPointsDisplay()}`;
                }
            }
            feedbackMessage.classList.remove('hidden');

            // Clear message after a short delay
            setTimeout(() => feedbackMessage.classList.add('hidden'), 5000); 

            // Re-render shop to update points display in the settings modal if open
            if (settingsModal.classList.contains('hidden') === false) {
                renderShop();
            }
        }
        window.submitFeedback = submitFeedback; // Expose globally


        // --- UTILITY FUNCTIONS ---
        /**
         * Gets a user-friendly string for the current points.
         */
        function getPointsDisplay() {
            return isDevMode ? "‚àû (Dev Mode)" : userPoints.toLocaleString();
        }

        /**
         * Checks if a string is a valid URL or IP address.
         */
        window.isValidUrl = function(str) {
            try {
                // Check if it's a URL (must include a scheme for new URL() to work well)
                new URL(str.startsWith('http') ? str : `https://${str}`);
                return true;
            } catch (e) {
                // Check for domain.tld or ip.address.here
                const simpleDomainRegex = /^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(:\d+)?$/;
                return simpleDomainRegex.test(str.toLowerCase());
            }
        }

        /**
         * Sets the primary theme for the entire application.
         */
        window.setTheme = function(themeName, save = true) {
            const themeMap = {
                'premium': { name: 'Premium' },
                'cyberpunk': { name: 'Cyberpunk' },
                'ocean': { name: 'Ocean' },
                'forest': { name: 'Forest' },
                'sunset': { name: 'Sunset' },
                'classic': { name: 'Classic' }
            };

            const isLockedTheme = themeName !== 'light' && themeName !== 'dark' && themeName !== 'monochrome' && themeName !== 'golden';
            const isOwnedTheme = ownedThemes.includes(themeName) || (themeName === PREMIUM_THEME_KEY && isPremium);
            const isPremiumTheme = themeName === PREMIUM_THEME_KEY;

            if (isLockedTheme && !isOwnedTheme && !isDevMode && !isPremiumTheme) {
                 // Prevent setting a locked theme unless it's a default one
                 alert(`Theme "${themeName.charAt(0).toUpperCase() + themeName.slice(1)}" is locked. Please purchase it in the shop.`);
                 // Revert to the last saved theme
                 themeName = localStorage.getItem('theme') || 'dark';
            }

            // 2. Remove all theme classes
            const allThemeClasses = ['dark-mode', 'monochrome-theme', 'golden-theme', PREMIUM_THEME_KEY + '-theme'];
            Object.keys(SHOP_ITEMS).forEach(key => {
                 if (SHOP_ITEMS[key].type === 'theme') {
                    allThemeClasses.push(SHOP_ITEMS[key].themeKey + '-theme');
                 }
            });
            document.body.classList.remove(...allThemeClasses);

            // 3. Apply the chosen theme class
            if (themeName === 'dark') {
                document.body.classList.add('dark-mode');
            } else if (themeName === 'monochrome') {
                document.body.classList.add('monochrome-theme');
            } else if (themeName === 'golden') {
                 document.body.classList.add('golden-theme');
            } else if (themeName !== 'light') {
                // All other themes use the structure [themeName]-theme
                document.body.classList.add(themeName + '-theme');
            }

            // 4. Save
            if (save) {
                 localStorage.setItem('theme', themeName);
            }

            // 5. Update selector (if available)
            if (themeSelector) {
                 themeSelector.value = themeName;
            }
        }

        /**
         * Saves the site view preference.
         */
        function saveSiteViewPreference(preference) {
            siteViewPreference = preference;
            localStorage.setItem('siteViewPreference', preference);
        }
        window.saveSiteViewPreference = saveSiteViewPreference; // Expose globally

        // --- CLOCK AND TIMER LOGIC ---
        /**
         * Updates the live time display in the header.
         */
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('live-clock').textContent = timeString;
        }

        /**
         * Sets a simple countdown timer.
         */
        function setSimpleTimer() {
            if (timerTimeout) {
                clearTimeout(timerTimeout);
                clearInterval(countdownInterval);
                timerTimeout = null;
                countdownInterval = null;
                document.getElementById('timer-status').textContent = 'Timer cancelled.';
                return;
            }

            const minutes = parseInt(document.getElementById('timer-input').value, 10);
            const statusSpan = document.getElementById('timer-status');
            
            if (isNaN(minutes) || minutes <= 0) {
                statusSpan.textContent = 'Please enter a valid number of minutes.';
                return;
            }
            
            let timeRemaining = minutes * 60; // in seconds

            function updateCountdown() {
                const mins = Math.floor(timeRemaining / 60);
                const secs = timeRemaining % 60;
                statusSpan.textContent = `Timer: ${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                if (timeRemaining <= 0) {
                    clearInterval(countdownInterval);
                    timerTimeout = null;
                    statusSpan.textContent = 'TIME IS UP! ‚è∞';
                    // Play a sound or flash the screen for a real app
                    alert('Time is up!');
                }
                timeRemaining--;
            }

            updateCountdown(); // Initial call
            countdownInterval = setInterval(updateCountdown, 1000);
            statusSpan.textContent = 'Timer running...';
        }
        window.setSimpleTimer = setSimpleTimer; // Expose globally


        // --- NEW MUSIC PLAYER (YOUTUBE) LOGIC ---
        /**
         * Extracts a YouTube Video ID or Playlist ID from a given URL or raw input.
         *
         * @param {string} url - The URL or ID provided by the user.
         * @returns {object|null} An object with { type: 'video'/'playlist', id: '...' } or null if invalid.
         */
        function extractYouTubeId(url) {
            let videoMatch = url.match(/(?:v=|youtu\.be\/|embed\/)([^&?]*)/);
            let playlistMatch = url.match(/[?&]list=([^&]*)/);

            if (playlistMatch && playlistMatch[1].startsWith('PL')) {
                return { type: 'playlist', id: playlistMatch[1] };
            } else if (videoMatch && videoMatch[1].length === 11) {
                return { type: 'video', id: videoMatch[1] };
            }
            // Handle raw 11-character ID being pasted
            if (url.length === 11 && !url.includes(' ')) {
                return { type: 'video', id: url };
            }
            // Handle raw Playlist ID (starts with PL)
            if (url.startsWith('PL') && url.length >= 16) { // YouTube playlist IDs are usually 16+ chars
                return { type: 'playlist', id: url };
            }
            
            return null;
        }

        /**
         * Loads the YouTube IFrame player based on user input.
         */
        function loadYouTubePlayer() {
            const inputElement = document.getElementById('musicUrlInput');
            const container = document.getElementById('playerEmbedContainer');
            const statusDisplay = document.getElementById('music-player-status');
            const url = inputElement.value.trim();

            container.innerHTML = '';
            statusDisplay.innerHTML = `Status: <span class="text-yellow-500 font-bold">Loading...</span>`;

            const result = extractYouTubeId(url);

            if (!result) {
                // Restore placeholder and show error status
                container.innerHTML = `<p id="playerPlaceholder" class="text-center text-red-500 py-10">
                    Invalid YouTube URL or ID. Please check the format.
                </p>`;
                statusDisplay.innerHTML = `Status: <span class="text-red-500 font-bold">Invalid URL or ID.</span>`;
                return;
            }

            let embedUrl = '';
            const width = '100%';
            const height = '315';
            
            // Construct the embed URL based on type
            if (result.type === 'playlist') {
                // Loads a playlist player
                embedUrl = `https://www.youtube.com/embed/videoseries?list=${result.id}&autoplay=1&rel=0`;
            } else if (result.type === 'video') {
                // Loads a single video player
                embedUrl = `https://www.youtube.com/embed/${result.id}?autoplay=1&rel=0`;
            }

            // Generate the iframe element
            container.innerHTML = `
                <iframe width="${width}" height="${height}" 
                    src="${embedUrl}" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen 
                    class="rounded-lg shadow-xl w-full h-full">
                </iframe>
            `;

            statusDisplay.innerHTML = `Status: <span class="text-green-500 font-bold">Player Loaded! (${result.type.charAt(0).toUpperCase() + result.type.slice(1)})</span>`;
        }
        window.loadYouTubePlayer = loadYouTubePlayer; // Expose globally

        // --- SHOP AND PURCHASE LOGIC ---
        
        const themeMap = {
            'premium': { name: 'Premium' },
            'cyberpunk': { name: 'Cyberpunk' },
            'ocean': { name: 'Ocean' },
            'forest': { name: 'Forest' },
            'sunset': { name: 'Sunset' },
            'classic': { name: 'Classic' }
        };

        /**
         * Renders the shop items and updates the points display.
         */
        function renderShop() {
            if (!shopItemsContainer) return;
            shopItemsContainer.innerHTML = '';
            pointsDisplay.textContent = getPointsDisplay();

            Object.keys(SHOP_ITEMS).forEach(key => {
                const item = SHOP_ITEMS[key];
                const isOwned = (item.type === 'theme' && ownedThemes.includes(item.themeKey)) || (item.type === 'membership' && isPremium);
                
                let buttonText = isOwned ? 'Owned' : `Buy for ${item.cost} Pts`;
                if (isDevMode && !isOwned) buttonText = `Buy for 0 Pts (Dev)`;

                const buttonColor = isOwned ? 'bg-gray-400 hover:bg-gray-500' : (isDevMode || userPoints >= item.cost ? 'bg-green-600 hover:bg-green-700' : 'bg-red-400');
                const isDisabled = isOwned || (!isDevMode && userPoints < item.cost);

                let premiumInfo = '';
                if (key === 'premium_membership' && isOwned) {
                    // Simulated premium code
                    const premiumCode = 'STARZ-PREM-1337-CODE';
                    premiumInfo = `<p class="mt-2 text-xs text-yellow-500 dark:text-yellow-300 font-mono break-all">Lifetime Code: ${premiumCode}</p>`;
                }

                const itemHtml = `
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow-md border ${isOwned ? 'border-indigo-400' : 'border-gray-200 dark:border-gray-600'}">
                        <h4 class="text-lg font-bold ${isOwned ? 'text-indigo-600 dark:text-indigo-400' : 'text-gray-800 dark:text-white'}">${item.name}</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${item.description}</p>
                        ${premiumInfo}
                        <button onclick="buyItem('${key}')" class="mt-3 w-full px-4 py-2 ${buttonColor} text-white font-semibold rounded-lg transition duration-300 disabled:opacity-50" ${isDisabled ? 'disabled' : ''} >
                            ${buttonText}
                        </button>
                    </div>
                `;
                shopItemsContainer.innerHTML += itemHtml;
            });

            // Add shop themes and premium theme in the selector
            Object.values(themeMap).forEach(item => {
                const isOwned = ownedThemes.includes(item.themeKey) || (item.themeKey === PREMIUM_THEME_KEY && isPremium);
                const themeName = item.name.replace(' Theme', '');
                let option = themeSelector.querySelector(`option[value="${item.themeKey}"]`);
                
                if (!option) {
                    option = document.createElement('option');
                    option.value = item.themeKey;
                    option.textContent = isOwned ? `${themeName} Theme` : `${themeName} Theme (Locked)`;
                    themeSelector.appendChild(option);
                } else {
                     option.textContent = isOwned ? `${themeName} Theme` : `${themeName} Theme (Locked)`;
                }
                option.disabled = !isOwned && !isDevMode;
            });
            
            // Set the current theme in the selector
            themeSelector.value = localStorage.getItem('theme') || 'dark';
        }


        /**
         * Handles the logic for buying a shop item.
         */
        function buyItem(key) {
            const item = SHOP_ITEMS[key];
            const isOwned = (item.type === 'theme' && ownedThemes.includes(item.themeKey)) || (item.type === 'membership' && isPremium);

            if (isOwned) {
                alert(`You already own ${item.name}.`);
                return;
            }

            if (!isDevMode && userPoints < item.cost) {
                alert(`You need ${item.cost - userPoints} more points to buy ${item.name}.`);
                return;
            }
            
            const cost = isDevMode ? 0 : item.cost;
            
            // Deduct points
            userPoints -= cost;
            localStorage.setItem('userPoints', userPoints.toString());

            // Handle theme purchase
            if (item.type === 'theme') {
                ownedThemes.push(item.themeKey);
                localStorage.setItem('ownedThemes', JSON.stringify(ownedThemes));
                setTheme(item.themeKey, true); // switch to new theme
            } 
            // Handle premium purchase
            else if (item.type === 'membership') {
                isPremium = true;
                localStorage.setItem('isPremium', 'true');
            }

            // Re-render to update points and button status
            renderShop();

            // Give feedback
            alert(`Purchase successful! You bought ${item.name}.`);
        }
        window.buyItem = buyItem; // Expose globally
        
        // --- DEV MODE LOGIC ---

        /**
         * Checks the Dev Status on load and applies changes.
         */
        function checkDevStatus(updateThemeSelector = false) {
            if (isDevMode) {
                devPanelDiv.classList.remove('hidden');
                devStatusMessage.innerHTML = 'Status: <span class="text-green-500 font-bold">Activated (GOLD)</span>';
                // Devs get 999999 points (Simulated infinite points)
                window.userPoints = 999999; 
                
                if (updateThemeSelector) {
                    const goldenOption = themeSelector.querySelector('option[value="golden"]');
                    if (!goldenOption) {
                        const option = document.createElement('option');
                        option.value = 'golden';
                        option.textContent = 'Golden Theme (DEV ONLY)';
                        themeSelector.appendChild(option);
                    }
                }
            } else {
                devPanelDiv.classList.add('hidden');
                devStatusMessage.innerHTML = 'Status: <span class="text-gray-500 font-normal">Disabled</span>';
                
                // Reset points from stored value if Dev Mode is off
                window.userPoints = parseInt(localStorage.getItem('userPoints') || '100', 10);
                
                if (updateThemeSelector) {
                    const goldenOption = themeSelector.querySelector('option[value="golden"]');
                    if (goldenOption) {
                        goldenOption.remove();
                    }
                }
            }
            
            if (updateThemeSelector) {
                renderShop(); // Re-render the shop to update points/buttons based on dev status
            }
        }
        window.checkDevStatus = checkDevStatus; // Expose globally


        /**
         * Attempts to activate Dev Mode with a custom ID. (NEW)
         */
        function applyCustomId() {
            const input = document.getElementById('custom-dev-id-input');
            const id = input.value.trim().toUpperCase();
            
            if (DEV_IDS.includes(id)) {
                isDevMode = true;
                localStorage.setItem('isDevMode', 'true');
                checkDevStatus(true);
                devStatusMessage.innerHTML = 'Status: <span class="text-green-500 font-bold">Activated (GOLD)</span>. Restart to apply Dev Panel on main page.';
                input.value = '';
            } else {
                devStatusMessage.innerHTML = 'Status: <span class="text-red-500 font-bold">Invalid ID</span>. Try again.';
            }
        }
        window.applyCustomId = applyCustomId; // Expose globally


        /**
         * Opens the settings modal.
         */
        function openSettings() {
            loadSettings(); // Load current settings into the UI when opening
            settingsModal.classList.remove('hidden');
            settingsOverlay.classList.remove('hidden');
        }
        window.openSettings = openSettings; // Expose globally

        /**
         * Closes the settings modal.
         */
        function closeSettings() {
            settingsModal.classList.add('hidden');
            settingsOverlay.classList.add('hidden');
        }
        window.closeSettings = closeSettings; // Expose globally

        /**
         * Loads all user settings from local storage into the UI.
         */
        function loadSettings() {
            // Check Dev Status first to set points and unlock the Golden theme option
            checkDevStatus(true);
            
            // User ID
            let userId = localStorage.getItem('userId');
            if (!userId) {
                userId = Math.random().toString(36).substring(2, 10).toUpperCase();
                localStorage.setItem('userId', userId);
            }
            userIdDisplay.textContent = userId;

            // Theme
            setTheme(localStorage.getItem('theme') || 'dark', false); // Apply theme but don't re-save

            // Site View Preference
            siteViewSelector.value = localStorage.getItem('siteViewPreference') || 'prompt';

            // Render the shop
            renderShop();
        }


        // --- SEARCH AND IFRAME LOGIC ---

        /**
         * Executes the search based on user input.
         */
        async function performSearch() {
            const query = searchInput.value.trim();
            if (!query) {
                alert("Please enter a search query or a website address.");
                return;
            }

            // Reset UI state
            resultsDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            directLinkDiv.classList.add('hidden');
            iframeViewerDiv.classList.add('hidden');
            loadingDiv.classList.add('hidden');
            searchButton.disabled = true;
            searchInput.disabled = true;
            summaryTextDiv.innerHTML = '';
            sourcesList.innerHTML = '';
            
            // Log the search query for Top Searches
            if (typeof window.logSearch === 'function') {
                 window.logSearch(query);
            }

            // --- Step 2: Check for Direct URL Navigation ---
            if (window.isValidUrl(query)) {
                directLinkTextSpan.textContent = query;
                searchButton.disabled = false;
                searchInput.disabled = false;

                // If preference is 'newtab', open directly
                if (siteViewPreference === 'newtab') {
                    navigateToUrl(true);
                    return;
                } 
                // If preference is 'internal', try internal embed directly
                else if (siteViewPreference === 'internal') {
                    navigateToUrl(false);
                    return;
                }
                // If preference is 'prompt', show the direct link container
                else {
                    directLinkDiv.classList.remove('hidden');
                    return;
                }
            }

            // --- Step 3: Proceed with Mock Search (API disabled) ---
            await startLoadingEngine(query);
            
            // Once loading is done, show the results
            try {
                // Simulate processing time after loading (minimal delay)
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Use the mock response
                displayResults(MOCK_SUMMARY, MOCK_SOURCES);
                
                // Add points for a successful search
                if (!isDevMode) {
                    userPoints += 5;
                    localStorage.setItem('userPoints', userPoints.toString());
                }

            } catch (e) {
                displayError("Search failed due to a simulated API error. Try another query.");
            } finally {
                searchButton.disabled = false;
                searchInput.disabled = false;
                loadingDiv.classList.add('hidden');
                
                // Refresh Top Searches in the background
                if (window.loadTopSearches) {
                    window.loadTopSearches();
                }
            }
        }
        window.performSearch = performSearch; // Expose globally

        /**
         * Performs a search using a Top Search quick button.
         */
        window.performQuickSearch = function(queryText) {
            searchInput.value = queryText;
            performSearch();
        }
        
        /**
         * Navigates to a URL either in a new tab or internally in the iframe.
         * @param {boolean} inNewTab - If true, opens a new tab. Otherwise, uses the internal iframe.
         */
        function navigateToUrl(inNewTab) {
            const url = searchInput.value.trim();
            const normalizedUrl = url.startsWith('http') ? url : `https://${url}`;
            
            searchFormContainer.classList.add('hidden');
            directLinkDiv.classList.add('hidden');
            resultsDiv.classList.add('hidden');
            iframeViewerDiv.classList.remove('hidden');
            
            if (inNewTab) {
                window.open(normalizedUrl, '_blank');
                // Immediately go back to search view since the user left the app
                window.resetToSearch();
            } else {
                // Internal Iframe View
                externalIframe.src = normalizedUrl;
                document.body.classList.add('fullscreen-active'); // Apply fullscreen styling
                mainContentCard.classList.add('fullscreen-mode');
                
                // Fallback timer in case the iframe fails to load (due to X-Frame-Options or other headers)
                const timer = setTimeout(() => {
                    // Check if the iframe content is still 'about:blank' or if a load event was not detected
                    // Note: Direct cross-origin check is blocked, so we assume failure if no content is visible after a timeout.
                    document.getElementById('iframe-fallback').style.opacity = '1'; 
                }, 3000); // 3 seconds to check loading

                // Clear state when the user goes back to search
                window.resetToSearch = () => {
                    clearTimeout(timer); // Prevent fallback from appearing late
                    iframeViewerDiv.classList.add('hidden');
                    searchFormContainer.classList.remove('hidden');
                    document.getElementById('iframe-fallback').style.opacity = '0'; 
                    document.body.classList.remove('fullscreen-active'); 
                    mainContentCard.classList.remove('fullscreen-mode');
                    // Reset state
                    externalIframe.src = 'about:blank'; // Clear content
                    searchInput.focus();
                };
            }
        }
        window.navigateToUrl = navigateToUrl; // Expose globally

        /**
         * Simulates opening an internal link (used for Games section).
         */
        function openGameInternally(domain) {
            searchInput.value = domain;
            navigateToUrl(false);
        }
        window.openGameInternally = openGameInternally; // Expose globally


        /**
         * Controls the custom loading engine animation and time.
         */
        async function startLoadingEngine(query) {
            loadingEngineOverlay.classList.remove('hidden');

            // 1. Determine load time (Premium benefit)
            const totalLoadTime = isPremium ? PREMIUM_LOAD_TIME : STANDARD_LOAD_TIME;
            
            // 2. Randomize Concurrent Users (500 to 2000)
            const randomUsers = Math.floor(Math.random() * 1501) + 500;
            concurrentUsersSpan.textContent = randomUsers.toLocaleString();

            // 3. Random Tip
            const randomTip = TIPS[Math.floor(Math.random() * TIPS.length)];
            loadingTipP.textContent = randomTip;

            // 4. Emoji Animation (3 seconds)
            let emojiCounter = 0;
            loadingEmojiDiv.classList.add('animate-pulse-once');
            emojiInterval = setInterval(() => {
                loadingEmojiDiv.textContent = EMOJIS[emojiCounter % EMOJIS.length];
                loadingEmojiDiv.classList.remove('animate-pulse-once'); // Remove before re-adding
                void loadingEmojiDiv.offsetWidth; // Trigger reflow
                loadingEmojiDiv.classList.add('animate-pulse-once');

                emojiCounter++;
            }, 500); // Change emoji every 0.5 seconds for the first part of the load

            // 5. Countdown and Progress Bar
            let currentTime = totalLoadTime;
            let totalTimeMs = totalLoadTime * 1000;
            let startTime = Date.now();
            
            loadCountdownSpan.textContent = `${totalLoadTime}s`;
            loadProgressBar.style.width = '0%';

            countdownInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const remaining = Math.max(0, totalTimeMs - elapsed);
                
                // Update countdown text
                const secondsRemaining = Math.ceil(remaining / 1000);
                loadCountdownSpan.textContent = `${secondsRemaining}s`;

                // Update progress bar
                let progress = (elapsed / totalTimeMs) * 100;
                loadProgressBar.style.width = `${Math.min(100, progress)}%`;

                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 100);

            // 6. Wait for the total load time
            await new Promise(resolve => {
                loadTimeout = setTimeout(() => {
                    clearInterval(emojiInterval);
                    clearInterval(countdownInterval);
                    loadingEngineOverlay.classList.add('hidden');
                    resolve();
                }, totalTimeMs);
            });
        }
        window.startLoadingEngine = startLoadingEngine; // Expose globally

        /**
         * Displays the search results summary and sources.
         */
        function displayResults(summary, sources) {
            summaryTextDiv.innerHTML = summary.replace(/\n/g, '<br>'); // Handle newlines
            resultsDiv.classList.remove('hidden');
            // Re-enable feedback buttons
            feedbackSection.querySelectorAll('button').forEach(btn => btn.disabled = false);

            sourcesList.innerHTML = '';
            if (sources && sources.length > 0) {
                sources.forEach(source => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-start space-x-2';
                    listItem.innerHTML = `
                        <svg class="w-4 h-4 mt-1 flex-shrink-0 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        <a href="${source.url}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline transition duration-300 dark:text-indigo-400">
                            ${source.title}
                        </a>
                    `;
                    sourcesList.appendChild(listItem);
                });
            } else {
                sourcesList.innerHTML = '<li class="text-gray-400">No specific web sources found for grounding this answer.</li>';
            }
        }

        /**
         * Displays an error message in the dedicated error container.
         */
        function displayError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden'); 
            directLinkDiv.classList.add('hidden'); 
            iframeViewerDiv.classList.add('hidden'); 
            searchFormContainer.classList.remove('hidden'); 
        }

        // --- FIREBASE MOCK: TOP SEARCHES LOGIC ---
        /**
         * Logs a successful, non-URL search query to Firestore.
         */
        window.logSearch = async function(query) {
            if (!db || query.length < 5) return;
            try {
                const searchesCollectionPath = CHAT_STORAGE_KEY.replace('chat_messages', 'top_searches');
                 // Use a simple mock add operation
                if (db.collection) { 
                    await db.collection(searchesCollectionPath).add({ 
                        query: query, 
                        timestamp: Date.now() 
                    });
                }
            } catch (error) {
                console.error("Error logging search to Firestore:", error);
            }
        }

        /**
         * Fetches and displays the most popular searches from Firestore.
         */
        window.loadTopSearches = async function() {
            if (!db) { 
                document.getElementById('no-searches-message').classList.remove('hidden');
                return;
            }
            const topSearchesDiv = document.getElementById('top-searches');
            const noSearchesMessage = document.getElementById('no-searches-message');
            const loadingSpan = document.getElementById('loading-searches');
            loadingSpan.classList.remove('hidden');
            topSearchesDiv.innerHTML = '';
            noSearchesMessage.classList.add('hidden');

            try {
                const searchesCollectionPath = CHAT_STORAGE_KEY.replace('chat_messages', 'top_searches');
                let querySnapshot;

                // Mock fetching sorted and limited results (based on count implemented in the mock)
                if (db.collection) { 
                    const q = db.collection(searchesCollectionPath).orderBy('timestamp', 'desc').limit(5);
                    querySnapshot = await q.get();
                }

                const searchCounts = {};

                if (querySnapshot && querySnapshot.docs.length > 0) {
                     querySnapshot.docs.forEach(doc => {
                         const data = doc.data();
                         // The mock returns pre-aggregated counts for simplicity
                         searchCounts[data.query] = data.count; 
                     });

                     const uniqueQueries = Object.keys(searchCounts)
                        .sort((a, b) => searchCounts[b] - searchCounts[a])
                        .slice(0, 5); // Display top 5 unique queries

                    if (uniqueQueries.length > 0) {
                        uniqueQueries.forEach(queryText => {
                             const button = document.createElement('button');
                             button.className = 'px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium hover:bg-blue-200 transition duration-300 dark:bg-gray-700 dark:text-blue-400 dark:hover:bg-gray-600 shadow-sm';
                             button.textContent = queryText;
                             button.onclick = () => window.performQuickSearch(queryText);
                             topSearchesDiv.appendChild(button);
                        });
                    } else {
                        noSearchesMessage.classList.remove('hidden');
                    }
                } else {
                    noSearchesMessage.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Error loading top searches:", error);
                noSearchesMessage.classList.remove('hidden');
            } finally {
                loadingSpan.classList.add('hidden');
            }
        }
        window.loadTopSearches = loadTopSearches;


        // Set initial focus and initialize modes
        window.onload = () => {
             searchInput.focus();
             loadSettings(); // Load all settings (theme, dev status, etc.)
             updateClock(); // Initialize clock
             setInterval(updateClock, 1000); // Update clock every second
             
             // NEW: Initialize the chat listener
             if (typeof initChat === 'function') {
                 initChat();
             }
             
             // Call loadTopSearches ONLY after the entire DOM is ready.
             if(window.loadTopSearches) {
                 window.loadTopSearches(); 
             }
        };

    </script>
</body>
</html>
