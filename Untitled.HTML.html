<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starz Search Mini-Engine</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }
        /* Ensure the iframe container has a defined height */
        #iframe-viewer {
            height: 60vh;
            min-height: 400px;
        }

        /* --- Fullscreen Simulation Styles (FIX) --- */
        body.fullscreen-active {
            /* Required to remove body scrollbars/margins when active */
            padding: 0 !important;
            margin: 0 !important;
            overflow: hidden;
        }

        .fullscreen-mode {
            position: fixed; /* Fix to viewport */
            top: 0;
            left: 0;
            width: 100vw !important; /* Override max-w-2xl */
            max-width: 100vw !important; /* Override max-w-2xl */
            height: 100vh;
            margin: 0 !important; /* Remove card margin */
            padding: 2rem !important; /* Adjust internal padding */
            border-radius: 0 !important;
            box-shadow: none !important; /* Remove box shadow in full screen */
            z-index: 100; /* Ensure it's above everything else */
            overflow-y: auto; /* Allow scrolling of content inside the card */
            background-color: #ffffff; /* Keep background white */
        }
        /* Ensure iframe viewer takes up available height in simulated fullscreen */
        .fullscreen-mode #iframe-viewer {
             height: calc(100vh - 150px); /* Adjust height to fill viewport minus header/back button */
             min-height: auto;
        }
    </style>
</head>
<!-- Added id="main-content-card" to the main content container -->
<body class="min-h-screen flex flex-col items-center p-4 sm:p-8">

    <div id="main-content-card" class="w-full max-w-2xl bg-white p-6 sm:p-10 rounded-xl shadow-2xl border border-gray-100 mt-10">

        <!-- Header -->
        <header class="text-center mb-8 relative">
            <!-- Updated to Starz Search for consistency with the file title -->
            <div class="text-4xl font-extrabold text-indigo-700">Starz Search</div>
            <p class="text-gray-500 mt-2">A mini-engine powered by real-time web knowledge.</p>
            
            <!-- Fullscreen Button (NEW) -->
            <button
                id="fullscreen-button"
                onclick="toggleFullscreen()"
                class="absolute top-0 right-0 p-2 text-gray-400 hover:text-indigo-600 transition duration-150 rounded-full hover:bg-gray-100"
                title="Toggle Fullscreen"
            >
                <svg id="fullscreen-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <!-- Icon path is set dynamically by JavaScript -->
                    <path id="fullscreen-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4 0l-5 5m-4 4v4m0 0h-4m4 0l-5-5m11 5v-4m0 0h-4m4 0l-5-5"></path>
                </svg>
            </button>
        </header>
        
        <!-- Iframe Viewer Container -->
        <div id="iframe-viewer" class="hidden w-full mt-8">
            <button
                id="back-button"
                onclick="resetToSearch()"
                class="mb-4 px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-300 transition duration-150 ease-in-out"
            >
                &larr; Back to Search
            </button>
            <div class="h-full border border-gray-300 rounded-lg overflow-hidden bg-gray-100 relative">
                <!-- The actual iframe with sandbox for security/compatibility -->
                <iframe 
                    id="external-iframe" 
                    class="w-full h-full" 
                    src="about:blank"
                    sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-modals"
                ></iframe>
                <!-- A simple overlay to explain potential blocking issues -->
                <div id="iframe-fallback" class="absolute inset-0 p-6 text-center text-gray-500 flex flex-col items-center justify-center pointer-events-none transition duration-500 opacity-0">
                    <svg class="w-8 h-8 text-red-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <p class="font-bold">Cannot display site.</p>
                    <p class="mt-1 text-sm">This website may block embedding (security policy).</p>
                    <a id="external-link-retry" href="#" target="_blank" rel="noopener noreferrer" class="mt-3 text-indigo-600 hover:underline text-sm font-medium">Click here to open in a new tab.</a>
                </div>
            </div>
        </div>

        <!-- Search and Direct Link Container -->
        <div id="search-form-container">
            <!-- Search Bar -->
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <input
                    id="search-input"
                    type="text"
                    placeholder="Ask anything, e.g., 'What are the latest discoveries in AI?' or 'cloudmoonapp.com'"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150 ease-in-out"
                    onkeypress="if(event.key === 'Enter') performSearch()"
                >
                <button
                    id="search-button"
                    onclick="performSearch()"
                    class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out disabled:opacity-50"
                >
                    Search
                </button>
            </div>

            <!-- Direct Navigation Link Suggestion (Updated to prioritize 'Open in New Tab') -->
            <div id="direct-link-container" class="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg shadow-sm hidden">
                <p class="text-sm font-medium text-yellow-800 mb-2">Did you mean to go directly to this site? (Recommended: Open in New Tab)</p>
                <button
                    onclick="navigateToUrl(true)" 
                    class="text-sm px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out"
                >
                    Open in New Tab
                </button>
                <button
                    id="direct-link-button"
                    onclick="navigateToUrl(false)" 
                    class="text-sm px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out ml-2"
                >
                    Try viewing <span id="direct-link-text" class="font-bold"></span> internally (May be blocked)
                </button>
            </div>
        </div>
        
        <!-- Developer Recommends Section -->
        <div class="mt-8 border-t border-gray-200 pt-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-1.75-3M16 17V3a1 1 0 00-1-1h-4a1 1 0 00-1 1v14"></path></svg>
                Developer Recommends
            </h3>
            <div id="developer-recommends" class="grid grid-cols-2 gap-4 sm:grid-cols-4">
                <!-- Links here still open in new tab -->
                <a href="https://cloudmoonapp.com/" target="_blank" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-indigo-100 transition duration-150 border border-gray-200 text-sm font-medium text-gray-700 hover:text-indigo-800 shadow-sm">
                    Cloud Moon App
                </a>
                <a href="https://play.geforcenow.com/" target="_blank" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-indigo-100 transition duration-150 border border-gray-200 text-sm font-medium text-gray-700 hover:text-indigo-800 shadow-sm">
                    NVIDIA GeForce NOW
                </a>
                <a href="https://www.youtube.com/" target="_blank" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-indigo-100 transition duration-150 border border-gray-200 text-sm font-medium text-gray-700 hover:text-indigo-800 shadow-sm">
                    YouTube
                </a>
                <a href="https://github.com/" target="_blank" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-indigo-100 transition duration-150 border border-gray-200 text-sm font-medium text-gray-700 hover:text-indigo-800 shadow-sm">
                    GitHub
                </a>
            </div>
        </div>

        <!-- Top Searches Section (NOW DYNAMIC) -->
        <div class="mt-8 border-t border-gray-200 pt-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Top Searches Today
                <span id="loading-searches" class="hidden ml-3 text-sm text-gray-500">Loading...</span>
            </h3>
            <div id="top-searches" class="flex flex-wrap gap-2 min-h-[40px] items-center">
                <p id="no-searches-message" class="text-gray-400 text-sm hidden">Start searching to see popular topics!</p>
                <!-- Dynamic search tags will be loaded here -->
            </div>
        </div>
        
        <!-- Games Section (UPDATED: Links now open internally) -->
        <div class="mt-8 border-t border-gray-200 pt-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Games Section
            </h3>
            <div id="games-section" class="grid grid-cols-2 gap-4 sm:grid-cols-4">
                <!-- Recommended Game Links - Using JS to open internally -->
                <a href="javascript:void(0)" onclick="openGameInternally('cloudmoonapp.com')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-150 border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm">
                    Cloud Moon App
                </a>
                <a href="javascript:void(0)" onclick="openGameInternally('play.geforcenow.com')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-150 border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm">
                    GeForce NOW
                </a>
                <a href="javascript:void(0)" onclick="openGameInternally('poki.com')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-150 border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm">
                    Poki (Web Games)
                </a>
                <a href="javascript:void(0)" onclick="openGameInternally('krunker.io')" class="p-3 text-center bg-gray-100 rounded-xl hover:bg-green-100 transition duration-150 border border-gray-200 text-sm font-medium text-gray-700 hover:text-green-800 shadow-sm">
                    Krunker.io
                </a>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="hidden text-center mt-6 text-indigo-600 font-medium">
            <div class="flex items-center justify-center space-x-2">
                <svg class="animate-spin h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Searching the web...</span>
            </div>
        </div>

        <!-- Results Container -->
        <div id="results" class="mt-8 pt-6 border-t border-gray-200 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Search Result</h2>

            <!-- Summary Text -->
            <div id="summary-text" class="p-5 bg-indigo-50 border-l-4 border-indigo-600 rounded-r-lg text-lg text-gray-700 leading-relaxed shadow-sm">
                <!-- LLM Generated Content will go here -->
            </div>

            <!-- Sources List -->
            <div class="mt-6">
                <h3 class="text-sm font-semibold uppercase text-gray-500 mb-2">Sources</h3>
                <ul id="sources-list" class="space-y-2 text-sm">
                    <!-- Grounding Metadata will go here -->
                </ul>
            </div>
        </div>

        <!-- Error Container -->
        <div id="error-message" class="hidden mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
            An error occurred. Please try again.
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let authReady = false;
        
        // Configuration and ID from the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug'); // Optional: Set log level for debugging
        }

        // Authentication Setup
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                authReady = true;
                // Load top searches after successful authentication
                if (window.loadTopSearches) {
                    window.loadTopSearches();
                }
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase authentication failed:", error);
                }
            }
        });

        /**
         * Logs a successful, non-URL search query to Firestore.
         * @param {string} query The search term.
         */
        window.logSearch = async function(query) {
            if (!authReady || !db || query.length < 5) return; // Only log substantial searches after auth is ready

            try {
                const searchesCollectionPath = `/artifacts/${appId}/public/data/top_searches`;
                await addDoc(collection(db, searchesCollectionPath), {
                    query: query,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Error logging search to Firestore:", error);
            }
        }
        
        /**
         * Fetches and displays the most popular searches from Firestore.
         */
        window.loadTopSearches = async function() {
            if (!db || !authReady) return;

            const topSearchesDiv = document.getElementById('top-searches');
            const loadingSpan = document.getElementById('loading-searches');
            const noSearchesMessage = document.getElementById('no-searches-message');
            topSearchesDiv.innerHTML = ''; // Clear existing content
            loadingSpan.classList.remove('hidden');

            try {
                const searchesCollectionPath = `/artifacts/${appId}/public/data/top_searches`;
                const q = query(
                    collection(db, searchesCollectionPath), 
                    orderBy('timestamp', 'desc'), 
                    limit(50) // Analyze last 50 queries for popularity
                );
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    noSearchesMessage.classList.remove('hidden');
                    loadingSpan.classList.add('hidden');
                    return;
                }

                const queryCounts = {};
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const queryText = data.query.trim().toLowerCase();
                    // Use only text queries (not URLs) for popularity
                    if (queryText && !window.isValidUrl(queryText)) { 
                        queryCounts[queryText] = (queryCounts[queryText] || 0) + 1;
                    }
                });

                // Convert to array, sort by count, and get top 5
                const sortedQueries = Object.entries(queryCounts)
                    .sort(([, countA], [, countB]) => countB - countA)
                    .slice(0, 5); // Take the top 5

                if (sortedQueries.length === 0) {
                     noSearchesMessage.classList.remove('hidden');
                } else {
                    noSearchesMessage.classList.add('hidden');
                    sortedQueries.forEach(([queryText]) => {
                        const button = document.createElement('button');
                        button.textContent = '#' + queryText.charAt(0).toUpperCase() + queryText.slice(1);
                        button.onclick = () => window.performQuickSearch(queryText);
                        button.className = "px-4 py-2 text-sm font-semibold rounded-full bg-blue-100 text-blue-800 hover:bg-blue-200 transition duration-150 shadow-sm";
                        topSearchesDiv.appendChild(button);
                    });
                }
            } catch (error) {
                console.error("Error loading top searches:", error);
                topSearchesDiv.innerHTML = `<p class="text-sm text-red-500">Error loading popular searches.</p>`;
            } finally {
                loadingSpan.classList.add('hidden');
            }
        }

    </script>
    <script>
        // Global variables provided by the canvas environment
        const apiKey = ""; // API Key will be injected at runtime
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";

        // --- UI Element References ---
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const loadingDiv = document.getElementById('loading');
        const resultsDiv = document.getElementById('results');
        const summaryTextDiv = document.getElementById('summary-text');
        const sourcesList = document.getElementById('sources-list');
        const errorDiv = document.getElementById('error-message');
        const searchFormContainer = document.getElementById('search-form-container'); 

        // UI References for direct link/iframe
        const directLinkDiv = document.getElementById('direct-link-container');
        const directLinkTextSpan = document.getElementById('direct-link-text');
        const iframeViewerDiv = document.getElementById('iframe-viewer'); 
        const externalIframe = document.getElementById('external-iframe'); 
        const iframeFallbackDiv = document.getElementById('iframe-fallback'); 
        const externalLinkRetry = document.getElementById('external-link-retry');
        
        // NEW reference for the main card container
        const mainContentCard = document.getElementById('main-content-card');
        
        // UI References for Fullscreen 
        const fullscreenIcon = document.getElementById('fullscreen-path');
        const FULLSCREEN_MAXIMIZE_D = 'M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4 0l-5 5m-4 4v4m0 0h-4m4 0l-5-5m11 5v-4m0 0h-4m4 0l-5-5';
        const FULLSCREEN_MINIMIZE_D = 'M4 8h4m-4 0V4m0 4L9 9m11-1h-4m4 0v-4m0 4L15 9m-4 4v4m0 0H7m4 0l-5 5m11-5v4m0 0h-4m4 0l-5-5';


        /**
         * Utility function to introduce exponential backoff for API retries.
         * (Omitted for brevity)
         */
        async function retryFetch(fetcher, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetcher();
                    if (response.status !== 429) {
                        return response;
                    }
                    const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000); 
                    await new Promise(resolve => setTimeout(resolve, delay));
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error('API call failed after multiple retries.');
        }

        /**
         * Checks if the input string is likely a URL.
         */
        window.isValidUrl = function(string) {
            const pattern = new RegExp(/^(https?:\/\/)?(www\.)?([a-zA-Z0-9-]+\.){1,}([a-zA-Z]{2,})(\S*)$/i);
            return pattern.test(string.trim());
        }
        
        /**
         * Performs a search using a predefined query (used for quick links).
         * @param {string} query 
         */
        window.performQuickSearch = function(query) {
            searchInput.value = query;
            performSearch();
        }
        
        /**
         * Dedicated function for opening a hardcoded URL link internally.
         * It sets the URL in the search input and triggers internal navigation (false for openInNewTab).
         * @param {string} url - The URL of the game to open.
         */
        function openGameInternally(url) {
            searchInput.value = url;
            navigateToUrl(false); 
        }

        /**
         * Handles direct navigation either internally (iframe) or externally (new tab).
         */
        function navigateToUrl(openInNewTab = false) {
            let url = searchInput.value.trim();
            
            // Prepend protocol if missing to ensure proper navigation
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            
            if (openInNewTab) {
                // Option 1: Open in a new tab
                window.open(url, '_blank');
            } else {
                // Option 2: Open internally in the iframe
                
                // 1. Hide search UI
                searchFormContainer.classList.add('hidden'); 
                resultsDiv.classList.add('hidden');
                errorDiv.classList.add('hidden');
                
                // 2. Show iframe UI
                iframeViewerDiv.classList.remove('hidden');

                // 3. Set the iframe source and related fallback link
                externalIframe.src = url;
                externalLinkRetry.href = url; // Link for the fallback message

                // 4. Handle iframe load state
                iframeFallbackDiv.style.opacity = '0';
                
                const timer = setTimeout(() => {
                     iframeFallbackDiv.style.opacity = '1';
                }, 3000); 

                externalIframe.onload = () => {
                    clearTimeout(timer);
                    iframeFallbackDiv.style.opacity = '0';
                };
            }
        }

        /**
         * Resets the view back to the search form.
         */
        function resetToSearch() {
            // 1. Hide iframe UI
            iframeViewerDiv.classList.add('hidden');
            externalIframe.src = 'about:blank'; // Clear iframe content
            iframeFallbackDiv.style.opacity = '0'; // Hide fallback

            // 2. Show search UI
            searchFormContainer.classList.remove('hidden');
            searchInput.focus();
        }

        // --- FULLSCREEN LOGIC (FIXED) ---

        /**
         * Updates the fullscreen icon based on the current fullscreen state (using class toggle).
         */
        function updateFullscreenIcon() {
            // Check if our custom class is present
            const isFullscreen = mainContentCard.classList.contains('fullscreen-mode');
            
            if (isFullscreen) {
                // Change icon to minimize (Exit Fullscreen)
                fullscreenIcon.setAttribute('d', FULLSCREEN_MINIMIZE_D);
            } else {
                // Change icon to maximize (Enter Fullscreen)
                fullscreenIcon.setAttribute('d', FULLSCREEN_MAXIMIZE_D);
            }
        }

        /**
         * Toggles the document's simulated fullscreen state using CSS.
         */
        function toggleFullscreen() {
            // Toggle the custom class on the main content card
            const isFullscreen = mainContentCard.classList.toggle('fullscreen-mode');

            // Also toggle a class on the body to handle background/padding
            document.body.classList.toggle('fullscreen-active', isFullscreen);
            
            // Update icon immediately
            updateFullscreenIcon();
        }
        
        /**
         * Main function to handle the search process.
         */
        async function performSearch() {
            const query = searchInput.value.trim();
            
            // --- Step 1: Initial Checks & State Reset ---
            if (!query) {
                displayError("Please enter a search query or a website address.");
                return;
            }

            // Reset UI state
            resultsDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            directLinkDiv.classList.add('hidden'); 
            iframeViewerDiv.classList.add('hidden'); 
            loadingDiv.classList.add('hidden');
            searchButton.disabled = true;
            searchInput.disabled = true;
            summaryTextDiv.innerHTML = '';
            sourcesList.innerHTML = '';
            
            // --- Step 2: Check for Direct URL Navigation ---
            if (window.isValidUrl(query)) {
                directLinkTextSpan.textContent = query;
                directLinkDiv.classList.remove('hidden');
                searchButton.disabled = false;
                searchInput.disabled = false;
                return; 
            }

            // --- Step 3: Proceed with Search (if not a URL) ---
            loadingDiv.classList.remove('hidden');

            try {
                const response = await callGeminiApi(query);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title); 
                    }

                    displayResults(text, sources);
                    // Log search query only if successful and not a URL
                    if (window.logSearch) {
                        window.logSearch(query);
                    }
                    if(window.loadTopSearches) {
                        window.loadTopSearches(); // Refresh top searches after a new one is logged
                    }

                } else {
                    displayError("Could not generate a response for this query.");
                }

            } catch (error) {
                console.error("Search failed:", error);
                displayError("Failed to connect to the search service. Check your connection or try a different query.");
            } finally {
                loadingDiv.classList.add('hidden');
                searchButton.disabled = false;
                searchInput.disabled = false;
            }
        }

        /**
         * Calls the Gemini API with Google Search grounding enabled.
         */
        function callGeminiApi(userQuery) {
            const systemPrompt = "You are a concise search engine summarization tool. Provide a direct, factual, and informative answer based strictly on the search results you find. Do not add conversational filler. If multiple results are found, synthesize them into a single, cohesive response. Present the result as a well-formatted paragraph or short block of text.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const fetcher = () => fetch(`${API_URL}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            return retryFetch(fetcher);
        }

        /**
         * Renders the generated text and sources.
         */
        function displayResults(text, sources) {
            resultsDiv.classList.remove('hidden');
            searchFormContainer.classList.remove('hidden'); 

            summaryTextDiv.innerHTML = text.split('\n').map(p => p.trim()).filter(p => p).join('<br><br>');

            sourcesList.innerHTML = '';
            if (sources.length > 0) {
                sources.forEach(source => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('flex', 'items-start', 'text-gray-600', 'hover:text-indigo-600');
                    listItem.innerHTML = `
                        <svg class="flex-shrink-0 w-4 h-4 mr-2 mt-1 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.108l4.108 4.108m2.147-6.046a3 3 0 010-4.242A3 3 0 0115.828 4m-2.147-6.046l-4.108 4.108"></path></svg>
                        <a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="truncate">${source.title} <span class="text-xs text-gray-400">(${new URL(source.uri).hostname})</span></a>
                    `;
                    sourcesList.appendChild(listItem);
                });
            } else {
                sourcesList.innerHTML = '<li class="text-gray-400">No specific web sources found for grounding this answer.</li>';
            }
        }

        /**
         * Displays an error message in the dedicated error container.
         */
        function displayError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden'); 
            directLinkDiv.classList.add('hidden'); 
            iframeViewerDiv.classList.add('hidden'); 
            searchFormContainer.classList.remove('hidden'); 
        }

        // Set initial focus and fullscreen icon state
        window.onload = () => {
             searchInput.focus();
             updateFullscreenIcon();
        };

    </script>
</body>
</html>